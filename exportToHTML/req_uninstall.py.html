<html>
<head>
<title>req_uninstall.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
req_uninstall.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">sysconfig</span>
<span class="s0">from </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">util </span><span class="s0">import </span><span class="s1">cache_from_source</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Callable</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">, </span><span class="s1">Generator</span><span class="s2">, </span><span class="s1">Iterable</span><span class="s2">, </span><span class="s1">List</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Set</span><span class="s2">, </span><span class="s1">Tuple</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">UninstallationError</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">locations </span><span class="s0">import </span><span class="s1">get_bin_prefix</span><span class="s2">, </span><span class="s1">get_bin_user</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">metadata </span><span class="s0">import </span><span class="s1">BaseDistribution</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">compat </span><span class="s0">import </span><span class="s1">WINDOWS</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">egg_link </span><span class="s0">import </span><span class="s1">egg_link_path_from_location</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">logging </span><span class="s0">import </span><span class="s1">getLogger</span><span class="s2">, </span><span class="s1">indent_log</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">misc </span><span class="s0">import </span><span class="s1">ask</span><span class="s2">, </span><span class="s1">normalize_path</span><span class="s2">, </span><span class="s1">renames</span><span class="s2">, </span><span class="s1">rmtree</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">temp_dir </span><span class="s0">import </span><span class="s1">AdjacentTempDirectory</span><span class="s2">, </span><span class="s1">TempDirectory</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_internal</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">virtualenv </span><span class="s0">import </span><span class="s1">running_under_virtualenv</span>

<span class="s1">logger </span><span class="s2">= </span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_script_names</span><span class="s2">(</span>
    <span class="s1">bin_dir</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">script_name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">is_gui</span><span class="s2">: </span><span class="s1">bool</span>
<span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
    <span class="s3">&quot;&quot;&quot;Create the fully qualified name of the files created by 
    {console,gui}_scripts for the given ``dist``. 
    Returns the list of file names 
    &quot;&quot;&quot;</span>
    <span class="s1">exe_name </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">bin_dir</span><span class="s2">, </span><span class="s1">script_name</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">exe_name</span>
    <span class="s0">if not </span><span class="s1">WINDOWS</span><span class="s2">:</span>
        <span class="s0">return</span>
    <span class="s0">yield </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">exe_name</span><span class="s0">}</span><span class="s4">.exe&quot;</span>
    <span class="s0">yield </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">exe_name</span><span class="s0">}</span><span class="s4">.exe.manifest&quot;</span>
    <span class="s0">if </span><span class="s1">is_gui</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">exe_name</span><span class="s0">}</span><span class="s4">-script.pyw&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">exe_name</span><span class="s0">}</span><span class="s4">-script.py&quot;</span>


<span class="s0">def </span><span class="s1">_unique</span><span class="s2">(</span>
    <span class="s1">fn</span><span class="s2">: </span><span class="s1">Callable</span><span class="s2">[..., </span><span class="s1">Generator</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]]</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">[..., </span><span class="s1">Generator</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]]:</span>
    <span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">unique</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
        <span class="s1">seen</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">fn</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">item </span><span class="s0">not in </span><span class="s1">seen</span><span class="s2">:</span>
                <span class="s1">seen</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
                <span class="s0">yield </span><span class="s1">item</span>

    <span class="s0">return </span><span class="s1">unique</span>


<span class="s2">@</span><span class="s1">_unique</span>
<span class="s0">def </span><span class="s1">uninstallation_paths</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">: </span><span class="s1">BaseDistribution</span><span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
    <span class="s3">&quot;&quot;&quot; 
    Yield all the uninstallation paths for dist based on RECORD-without-.py[co] 
 
    Yield paths to all the files in RECORD. For each .py file in RECORD, add 
    the .pyc and .pyo in the same directory. 
 
    UninstallPathSet.add() takes care of the __pycache__ .py[co]. 
 
    If RECORD is not found, raises UninstallationError, 
    with possible information from the INSTALLER file. 
 
    https://packaging.python.org/specifications/recording-installed-packages/ 
    &quot;&quot;&quot;</span>
    <span class="s1">location </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">location</span>
    <span class="s0">assert </span><span class="s1">location </span><span class="s0">is not None</span><span class="s2">, </span><span class="s4">&quot;not installed&quot;</span>

    <span class="s1">entries </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">iter_declared_entries</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">entries </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Cannot uninstall {dist}, RECORD file not found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">=</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">installer</span>
        <span class="s0">if not </span><span class="s1">installer </span><span class="s0">or </span><span class="s1">installer </span><span class="s2">== </span><span class="s4">&quot;pip&quot;</span><span class="s2">:</span>
            <span class="s1">dep </span><span class="s2">= </span><span class="s4">&quot;{}=={}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">msg </span><span class="s2">+= (</span>
                <span class="s4">&quot; You might be able to recover from this via: &quot;</span>
                <span class="s4">&quot;'pip install --force-reinstall --no-deps {}'.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">dep</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">+= </span><span class="s4">&quot; Hint: The package was installed by {}.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">installer</span><span class="s2">)</span>
        <span class="s0">raise </span><span class="s1">UninstallationError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">entries</span><span class="s2">:</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">location</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">)</span>
        <span class="s0">yield </span><span class="s1">path</span>
        <span class="s0">if </span><span class="s1">path</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;.py&quot;</span><span class="s2">):</span>
            <span class="s1">dn</span><span class="s2">, </span><span class="s1">fn </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">base </span><span class="s2">= </span><span class="s1">fn</span><span class="s2">[:-</span><span class="s5">3</span><span class="s2">]</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dn</span><span class="s2">, </span><span class="s1">base </span><span class="s2">+ </span><span class="s4">&quot;.pyc&quot;</span><span class="s2">)</span>
            <span class="s0">yield </span><span class="s1">path</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dn</span><span class="s2">, </span><span class="s1">base </span><span class="s2">+ </span><span class="s4">&quot;.pyo&quot;</span><span class="s2">)</span>
            <span class="s0">yield </span><span class="s1">path</span>


<span class="s0">def </span><span class="s1">compact</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]) </span><span class="s1">-&gt; Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
    <span class="s3">&quot;&quot;&quot;Compact a path set to contain the minimal number of paths 
    necessary to contain all paths in the set. If /a/path/ and 
    /a/path/to/a/file.txt are both in the set, leave only the 
    shorter path.&quot;&quot;&quot;</span>

    <span class="s1">sep </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">sep</span>
    <span class="s1">short_paths</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">len</span><span class="s2">):</span>
        <span class="s1">should_skip </span><span class="s2">= </span><span class="s1">any</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">shortpath</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s4">&quot;*&quot;</span><span class="s2">))</span>
            <span class="s0">and </span><span class="s1">path</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shortpath</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s4">&quot;*&quot;</span><span class="s2">).</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s1">sep</span><span class="s2">))] == </span><span class="s1">sep</span>
            <span class="s0">for </span><span class="s1">shortpath </span><span class="s0">in </span><span class="s1">short_paths</span>
        <span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">should_skip</span><span class="s2">:</span>
            <span class="s1">short_paths</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">short_paths</span>


<span class="s0">def </span><span class="s1">compress_for_rename</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]) </span><span class="s1">-&gt; Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
    <span class="s3">&quot;&quot;&quot;Returns a set containing the paths that need to be renamed. 
 
    This set may include directories when the original sequence of paths 
    included every file on disk. 
    &quot;&quot;&quot;</span>
    <span class="s1">case_map </span><span class="s2">= {</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">p</span><span class="s2">): </span><span class="s1">p </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">paths</span><span class="s2">}</span>
    <span class="s1">remaining </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">case_map</span><span class="s2">)</span>
    <span class="s1">unchecked </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">({</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">case_map</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()}, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">len</span><span class="s2">)</span>
    <span class="s1">wildcards</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">norm_join</span><span class="s2">(*</span><span class="s1">a</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(*</span><span class="s1">a</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">root </span><span class="s0">in </span><span class="s1">unchecked</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">root</span><span class="s2">).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">w</span><span class="s2">) </span><span class="s0">for </span><span class="s1">w </span><span class="s0">in </span><span class="s1">wildcards</span><span class="s2">):</span>
            <span class="s6"># This directory has already been handled.</span>
            <span class="s0">continue</span>

        <span class="s1">all_files</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">all_subdirs</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">subdirs</span><span class="s2">, </span><span class="s1">files </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">walk</span><span class="s2">(</span><span class="s1">root</span><span class="s2">):</span>
            <span class="s1">all_subdirs</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">norm_join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">d</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">subdirs</span><span class="s2">)</span>
            <span class="s1">all_files</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">norm_join</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">dirname</span><span class="s2">, </span><span class="s1">f</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">files</span><span class="s2">)</span>
        <span class="s6"># If all the files we found are in our remaining set of files to</span>
        <span class="s6"># remove, then remove them from the latter set and add a wildcard</span>
        <span class="s6"># for the directory.</span>
        <span class="s0">if not </span><span class="s2">(</span><span class="s1">all_files </span><span class="s2">- </span><span class="s1">remaining</span><span class="s2">):</span>
            <span class="s1">remaining</span><span class="s2">.</span><span class="s1">difference_update</span><span class="s2">(</span><span class="s1">all_files</span><span class="s2">)</span>
            <span class="s1">wildcards</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">root </span><span class="s2">+ </span><span class="s1">os</span><span class="s2">.</span><span class="s1">sep</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">set</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">case_map</span><span class="s2">.</span><span class="s1">__getitem__</span><span class="s2">, </span><span class="s1">remaining</span><span class="s2">)) | </span><span class="s1">wildcards</span>


<span class="s0">def </span><span class="s1">compress_for_output_listing</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]) </span><span class="s1">-&gt; Tuple</span><span class="s2">[</span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">], </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]]:</span>
    <span class="s3">&quot;&quot;&quot;Returns a tuple of 2 sets of which paths to display to user 
 
    The first set contains paths that would be deleted. Files of a package 
    are not added and the top-level directory of the package has a '*' added 
    at the end - to signify that all it's contents are removed. 
 
    The second set contains files that would have been skipped in the above 
    folders. 
    &quot;&quot;&quot;</span>

    <span class="s1">will_remove </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">)</span>
    <span class="s1">will_skip </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s6"># Determine folders and files</span>
    <span class="s1">folders </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">files </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">will_remove</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">path</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;.pyc&quot;</span><span class="s2">):</span>
            <span class="s0">continue</span>
        <span class="s0">if </span><span class="s1">path</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;__init__.py&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s4">&quot;.dist-info&quot; </span><span class="s0">in </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">folders</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>
        <span class="s1">files</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s6"># probably this one https://github.com/python/mypy/issues/390</span>
    <span class="s1">_normcased_files </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">, </span><span class="s1">files</span><span class="s2">))  </span><span class="s6"># type: ignore</span>

    <span class="s1">folders </span><span class="s2">= </span><span class="s1">compact</span><span class="s2">(</span><span class="s1">folders</span><span class="s2">)</span>

    <span class="s6"># This walks the tree using os.walk to not miss extra folders</span>
    <span class="s6"># that might get added.</span>
    <span class="s0">for </span><span class="s1">folder </span><span class="s0">in </span><span class="s1">folders</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">dirfiles </span><span class="s0">in </span><span class="s1">os</span><span class="s2">.</span><span class="s1">walk</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">dirfiles</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">fname</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;.pyc&quot;</span><span class="s2">):</span>
                    <span class="s0">continue</span>

                <span class="s1">file_ </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dirpath</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s2">(</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">file_</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">file_</span><span class="s2">) </span><span class="s0">not in </span><span class="s1">_normcased_files</span>
                <span class="s2">):</span>
                    <span class="s6"># We are skipping this file. Add it to the set.</span>
                    <span class="s1">will_skip</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">file_</span><span class="s2">)</span>

    <span class="s1">will_remove </span><span class="s2">= </span><span class="s1">files </span><span class="s2">| {</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">folder</span><span class="s2">, </span><span class="s4">&quot;*&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">folder </span><span class="s0">in </span><span class="s1">folders</span><span class="s2">}</span>

    <span class="s0">return </span><span class="s1">will_remove</span><span class="s2">, </span><span class="s1">will_skip</span>


<span class="s0">class </span><span class="s1">StashedUninstallPathSet</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot;A set of file rename operations to stash files while 
    tentatively uninstalling them.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6"># Mapping from source file root to [Adjacent]TempDirectory</span>
        <span class="s6"># for files under that directory.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs</span><span class="s2">: </span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">TempDirectory</span><span class="s2">] = {}</span>
        <span class="s6"># (old path, new path) tuples for each move that may need</span>
        <span class="s6"># to be undone.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moves</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]] = []</span>

    <span class="s0">def </span><span class="s1">_get_directory_stash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Stashes a directory. 
 
        Directories are stashed adjacent to their original location if 
        possible, or else moved/copied into the user's temp dir.&quot;&quot;&quot;</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">save_dir</span><span class="s2">: </span><span class="s1">TempDirectory </span><span class="s2">= </span><span class="s1">AdjacentTempDirectory</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">OSError</span><span class="s2">:</span>
            <span class="s1">save_dir </span><span class="s2">= </span><span class="s1">TempDirectory</span><span class="s2">(</span><span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;uninstall&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs</span><span class="s2">[</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)] = </span><span class="s1">save_dir</span>

        <span class="s0">return </span><span class="s1">save_dir</span><span class="s2">.</span><span class="s1">path</span>

    <span class="s0">def </span><span class="s1">_get_file_stash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Stashes a file. 
 
        If no root has been provided, one will be created for the directory 
        in the user's temp directory.&quot;&quot;&quot;</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">head</span><span class="s2">, </span><span class="s1">old_head </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">path</span><span class="s2">), </span><span class="s0">None</span>
        <span class="s1">save_dir </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">while </span><span class="s1">head </span><span class="s2">!= </span><span class="s1">old_head</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">save_dir </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs</span><span class="s2">[</span><span class="s1">head</span><span class="s2">]</span>
                <span class="s0">break</span>
            <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
                <span class="s0">pass</span>
            <span class="s1">head</span><span class="s2">, </span><span class="s1">old_head </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">head</span><span class="s2">), </span><span class="s1">head</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># Did not find any suitable root</span>
            <span class="s1">head </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">save_dir </span><span class="s2">= </span><span class="s1">TempDirectory</span><span class="s2">(</span><span class="s1">kind</span><span class="s2">=</span><span class="s4">&quot;uninstall&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs</span><span class="s2">[</span><span class="s1">head</span><span class="s2">] = </span><span class="s1">save_dir</span>

        <span class="s1">relpath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">relpath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">head</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">relpath </span><span class="s0">and </span><span class="s1">relpath </span><span class="s2">!= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">curdir</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">save_dir</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">relpath</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">save_dir</span><span class="s2">.</span><span class="s1">path</span>

    <span class="s0">def </span><span class="s1">stash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Stashes the directory or file and returns its new location. 
        Handle symlinks as files to avoid modifying the symlink targets. 
        &quot;&quot;&quot;</span>
        <span class="s1">path_is_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">islink</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">path_is_dir</span><span class="s2">:</span>
            <span class="s1">new_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_directory_stash</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">new_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_file_stash</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moves</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">path</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">path_is_dir </span><span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">):</span>
            <span class="s6"># If we're moving a directory, we need to</span>
            <span class="s6"># remove the destination first or else it will be</span>
            <span class="s6"># moved to inside the existing directory.</span>
            <span class="s6"># We just created new_path ourselves, so it will</span>
            <span class="s6"># be removable.</span>
            <span class="s1">os</span><span class="s2">.</span><span class="s1">rmdir</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">)</span>
        <span class="s1">renames</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">new_path</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Commits the uninstall by removing stashed files.&quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">save_dir </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">save_dir</span><span class="s2">.</span><span class="s1">cleanup</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moves </span><span class="s2">= []</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_save_dirs </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Undoes the uninstall by moving stashed files back.&quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_moves</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Moving to %s</span><span class="s0">\n </span><span class="s4">from %s&quot;</span><span class="s2">, *</span><span class="s1">p</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">new_path</span><span class="s2">, </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_moves</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">&quot;Replacing %s from %s&quot;</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">, </span><span class="s1">path</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">) </span><span class="s0">or </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">islink</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">):</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isdir</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">):</span>
                    <span class="s1">rmtree</span><span class="s2">(</span><span class="s1">new_path</span><span class="s2">)</span>
                <span class="s1">renames</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">ex</span><span class="s2">:</span>
                <span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Failed to restore %s&quot;</span><span class="s2">, </span><span class="s1">new_path</span><span class="s2">)</span>
                <span class="s1">logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">&quot;Exception: %s&quot;</span><span class="s2">, </span><span class="s1">ex</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">can_rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_moves</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">UninstallPathSet</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot;A set of file paths to be removed in the uninstallation of a 
    requirement.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">: </span><span class="s1">BaseDistribution</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_refuse</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">: </span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">UninstallPthEntries</span><span class="s2">] = {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_dist </span><span class="s2">= </span><span class="s1">dist</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moved_paths </span><span class="s2">= </span><span class="s1">StashedUninstallPathSet</span><span class="s2">()</span>
        <span class="s6"># Create local cache of normalize_path results. Creating an UninstallPathSet</span>
        <span class="s6"># can result in hundreds/thousands of redundant calls to normalize_path with</span>
        <span class="s6"># the same args, which hurts performance.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_normalize_path_cached </span><span class="s2">= </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">lru_cache</span><span class="s2">()(</span><span class="s1">normalize_path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_permitted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        Return True if the given path is one we are permitted to 
        remove/modify, False otherwise. 
 
        &quot;&quot;&quot;</span>
        <span class="s6"># aka is_local, but caching normalized sys.prefix</span>
        <span class="s0">if not </span><span class="s1">running_under_virtualenv</span><span class="s2">():</span>
            <span class="s0">return True</span>
        <span class="s0">return </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_normalize_path_cached</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">head</span><span class="s2">, </span><span class="s1">tail </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s6"># we normalize the head to resolve parent directory symlinks, but not</span>
        <span class="s6"># the tail, since we only want to uninstall symlinks, not their targets</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_normalize_path_cached</span><span class="s2">(</span><span class="s1">head</span><span class="s2">), </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">tail</span><span class="s2">))</span>

        <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_permitted</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_refuse</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s6"># __pycache__ files can show up after 'installed-files.txt' is created,</span>
        <span class="s6"># due to imports</span>
        <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">] == </span><span class="s4">&quot;.py&quot;</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">cache_from_source</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">add_pth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pth_file</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">pth_file </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_normalize_path_cached</span><span class="s2">(</span><span class="s1">pth_file</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_permitted</span><span class="s2">(</span><span class="s1">pth_file</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">pth_file </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">[</span><span class="s1">pth_file</span><span class="s2">] = </span><span class="s1">UninstallPthEntries</span><span class="s2">(</span><span class="s1">pth_file</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">[</span><span class="s1">pth_file</span><span class="s2">].</span><span class="s1">add</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_refuse</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">pth_file</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">auto_confirm</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Remove paths in ``self._paths`` with confirmation (unless 
        ``auto_confirm`` is True).&quot;&quot;&quot;</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                <span class="s4">&quot;Can't uninstall '%s'. No files were found to uninstall.&quot;</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">dist_name_version </span><span class="s2">= </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s0">}</span><span class="s4">-</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dist</span><span class="s2">.</span><span class="s1">version</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Uninstalling %s:&quot;</span><span class="s2">, </span><span class="s1">dist_name_version</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">indent_log</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">auto_confirm </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_allowed_to_proceed</span><span class="s2">(</span><span class="s1">verbose</span><span class="s2">):</span>
                <span class="s1">moved </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_moved_paths</span>

                <span class="s1">for_rename </span><span class="s2">= </span><span class="s1">compress_for_rename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">)</span>

                <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">compact</span><span class="s2">(</span><span class="s1">for_rename</span><span class="s2">)):</span>
                    <span class="s1">moved</span><span class="s2">.</span><span class="s1">stash</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s1">logger</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">(</span><span class="s4">&quot;Removing file or directory %s&quot;</span><span class="s2">, </span><span class="s1">path</span><span class="s2">)</span>

                <span class="s0">for </span><span class="s1">pth </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                    <span class="s1">pth</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>

                <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Successfully uninstalled %s&quot;</span><span class="s2">, </span><span class="s1">dist_name_version</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_allowed_to_proceed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Display which files would be deleted and prompt for confirmation&quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">_display</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">paths</span><span class="s2">:</span>
                <span class="s0">return</span>

            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">indent_log</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">compact</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">)):</span>
                    <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">will_remove</span><span class="s2">, </span><span class="s1">will_skip </span><span class="s2">= </span><span class="s1">compress_for_output_listing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># In verbose mode, display all the files that are going to be</span>
            <span class="s6"># deleted.</span>
            <span class="s1">will_remove </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">)</span>
            <span class="s1">will_skip </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

        <span class="s1">_display</span><span class="s2">(</span><span class="s4">&quot;Would remove:&quot;</span><span class="s2">, </span><span class="s1">will_remove</span><span class="s2">)</span>
        <span class="s1">_display</span><span class="s2">(</span><span class="s4">&quot;Would not remove (might be manually added):&quot;</span><span class="s2">, </span><span class="s1">will_skip</span><span class="s2">)</span>
        <span class="s1">_display</span><span class="s2">(</span><span class="s4">&quot;Would not remove (outside of prefix):&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_refuse</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">_display</span><span class="s2">(</span><span class="s4">&quot;Will actually move:&quot;</span><span class="s2">, </span><span class="s1">compress_for_rename</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">))</span>

        <span class="s0">return </span><span class="s1">ask</span><span class="s2">(</span><span class="s4">&quot;Proceed (Y/n)? &quot;</span><span class="s2">, (</span><span class="s4">&quot;y&quot;</span><span class="s2">, </span><span class="s4">&quot;n&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">)) != </span><span class="s4">&quot;n&quot;</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Rollback the changes previously made by remove().&quot;&quot;&quot;</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_moved_paths</span><span class="s2">.</span><span class="s1">can_rollback</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span>
                <span class="s4">&quot;Can't roll back %s; was not uninstalled&quot;</span><span class="s2">,</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Rolling back uninstall of %s&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moved_paths</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">pth </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pth</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">pth</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">commit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot;Remove temporary save dir: rollback will no longer be possible.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_moved_paths</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_dist</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">: </span><span class="s1">BaseDistribution</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s4">&quot;UninstallPathSet&quot;</span><span class="s2">:</span>
        <span class="s1">dist_location </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">location</span>
        <span class="s1">info_location </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">info_location</span>
        <span class="s0">if </span><span class="s1">dist_location </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                <span class="s4">&quot;Not uninstalling %s since it is not installed&quot;</span><span class="s2">,</span>
                <span class="s1">dist</span><span class="s2">.</span><span class="s1">canonical_name</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

        <span class="s1">normalized_dist_location </span><span class="s2">= </span><span class="s1">normalize_path</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">local</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                <span class="s4">&quot;Not uninstalling %s at %s, outside environment %s&quot;</span><span class="s2">,</span>
                <span class="s1">dist</span><span class="s2">.</span><span class="s1">canonical_name</span><span class="s2">,</span>
                <span class="s1">normalized_dist_location</span><span class="s2">,</span>
                <span class="s1">sys</span><span class="s2">.</span><span class="s1">prefix</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">normalized_dist_location </span><span class="s0">in </span><span class="s2">{</span>
            <span class="s1">p</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">{</span><span class="s1">sysconfig</span><span class="s2">.</span><span class="s1">get_path</span><span class="s2">(</span><span class="s4">&quot;stdlib&quot;</span><span class="s2">), </span><span class="s1">sysconfig</span><span class="s2">.</span><span class="s1">get_path</span><span class="s2">(</span><span class="s4">&quot;platstdlib&quot;</span><span class="s2">)}</span>
            <span class="s0">if </span><span class="s1">p</span>
        <span class="s2">}:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                <span class="s4">&quot;Not uninstalling %s at %s, as it is in the standard library.&quot;</span><span class="s2">,</span>
                <span class="s1">dist</span><span class="s2">.</span><span class="s1">canonical_name</span><span class="s2">,</span>
                <span class="s1">normalized_dist_location</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

        <span class="s1">paths_to_remove </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">develop_egg_link </span><span class="s2">= </span><span class="s1">egg_link_path_from_location</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">)</span>

        <span class="s6"># Distribution is installed with metadata in a &quot;flat&quot; .egg-info</span>
        <span class="s6"># directory. This means it is not a modern .dist-info installation, an</span>
        <span class="s6"># egg, or legacy editable.</span>
        <span class="s1">setuptools_flat_installation </span><span class="s2">= (</span>
            <span class="s1">dist</span><span class="s2">.</span><span class="s1">installed_with_setuptools_egg_info</span>
            <span class="s0">and </span><span class="s1">info_location </span><span class="s0">is not None</span>
            <span class="s0">and </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">info_location</span><span class="s2">)</span>
            <span class="s6"># If dist is editable and the location points to a ``.egg-info``,</span>
            <span class="s6"># we are in fact in the legacy editable case.</span>
            <span class="s0">and not </span><span class="s1">info_location</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">setuptools_filename</span><span class="s0">}</span><span class="s4">.egg-info&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s6"># Uninstall cases order do matter as in the case of 2 installs of the</span>
        <span class="s6"># same package, pip needs to uninstall the currently detected version</span>
        <span class="s0">if </span><span class="s1">setuptools_flat_installation</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">info_location </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">info_location</span><span class="s2">)</span>
            <span class="s1">installed_files </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">iter_declared_entries</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">installed_files </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">installed_file </span><span class="s0">in </span><span class="s1">installed_files</span><span class="s2">:</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">, </span><span class="s1">installed_file</span><span class="s2">))</span>
            <span class="s6"># FIXME: need a test for this elif block</span>
            <span class="s6"># occurs with --single-version-externally-managed/--record outside</span>
            <span class="s6"># of pip</span>
            <span class="s0">elif </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">is_file</span><span class="s2">(</span><span class="s4">&quot;top_level.txt&quot;</span><span class="s2">):</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">namespace_packages </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">read_text</span><span class="s2">(</span><span class="s4">&quot;namespace_packages.txt&quot;</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">FileNotFoundError</span><span class="s2">:</span>
                    <span class="s1">namespaces </span><span class="s2">= []</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">namespaces </span><span class="s2">= </span><span class="s1">namespace_packages</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">(</span><span class="s1">keepends</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">top_level_pkg </span><span class="s0">in </span><span class="s2">[</span>
                    <span class="s1">p</span>
                    <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">read_text</span><span class="s2">(</span><span class="s4">&quot;top_level.txt&quot;</span><span class="s2">).</span><span class="s1">splitlines</span><span class="s2">()</span>
                    <span class="s0">if </span><span class="s1">p </span><span class="s0">and </span><span class="s1">p </span><span class="s0">not in </span><span class="s1">namespaces</span>
                <span class="s2">]:</span>
                    <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">, </span><span class="s1">top_level_pkg</span><span class="s2">)</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">path</span><span class="s0">}</span><span class="s4">.py&quot;</span><span class="s2">)</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">path</span><span class="s0">}</span><span class="s4">.pyc&quot;</span><span class="s2">)</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">path</span><span class="s0">}</span><span class="s4">.pyo&quot;</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">installed_by_distutils</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">UninstallationError</span><span class="s2">(</span>
                <span class="s4">&quot;Cannot uninstall {!r}. It is a distutils installed project &quot;</span>
                <span class="s4">&quot;and thus we cannot accurately determine which files belong &quot;</span>
                <span class="s4">&quot;to it which would lead to only a partial uninstall.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
                    <span class="s1">dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">installed_as_egg</span><span class="s2">:</span>
            <span class="s6"># package installed by easy_install</span>
            <span class="s6"># We cannot match on dist.egg_name because it can slightly vary</span>
            <span class="s6"># i.e. setuptools-0.6c11-py2.6.egg vs setuptools-0.6rc11-py2.6.egg</span>
            <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">)</span>
            <span class="s1">easy_install_egg </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">easy_install_pth </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">dist_location</span><span class="s2">),</span>
                <span class="s4">&quot;easy-install.pth&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add_pth</span><span class="s2">(</span><span class="s1">easy_install_pth</span><span class="s2">, </span><span class="s4">&quot;./&quot; </span><span class="s2">+ </span><span class="s1">easy_install_egg</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">installed_with_dist_info</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">uninstallation_paths</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
                <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">develop_egg_link</span><span class="s2">:</span>
            <span class="s6"># PEP 660 modern editable is handled in the ``.dist-info`` case</span>
            <span class="s6"># above, so this only covers the setuptools-style editable.</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">develop_egg_link</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
                <span class="s1">link_pointer </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">fh</span><span class="s2">.</span><span class="s1">readline</span><span class="s2">().</span><span class="s1">strip</span><span class="s2">())</span>
                <span class="s1">normalized_link_pointer </span><span class="s2">= </span><span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">_normalize_path_cached</span><span class="s2">(</span>
                    <span class="s1">link_pointer</span>
                <span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">samefile</span><span class="s2">(</span>
                <span class="s1">normalized_link_pointer</span><span class="s2">, </span><span class="s1">normalized_dist_location</span>
            <span class="s2">), (</span>
                <span class="s4">f&quot;Egg-link </span><span class="s0">{</span><span class="s1">develop_egg_link</span><span class="s0">} </span><span class="s4">(to </span><span class="s0">{</span><span class="s1">link_pointer</span><span class="s0">}</span><span class="s4">) does not match &quot;</span>
                <span class="s4">f&quot;installed location of </span><span class="s0">{</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">raw_name</span><span class="s0">} </span><span class="s4">(at </span><span class="s0">{</span><span class="s1">dist_location</span><span class="s0">}</span><span class="s4">)&quot;</span>
            <span class="s2">)</span>
            <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">develop_egg_link</span><span class="s2">)</span>
            <span class="s1">easy_install_pth </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">develop_egg_link</span><span class="s2">), </span><span class="s4">&quot;easy-install.pth&quot;</span>
            <span class="s2">)</span>
            <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add_pth</span><span class="s2">(</span><span class="s1">easy_install_pth</span><span class="s2">, </span><span class="s1">dist_location</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span>
                <span class="s4">&quot;Not sure how to uninstall: %s - Check: %s&quot;</span><span class="s2">,</span>
                <span class="s1">dist</span><span class="s2">,</span>
                <span class="s1">dist_location</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">in_usersite</span><span class="s2">:</span>
            <span class="s1">bin_dir </span><span class="s2">= </span><span class="s1">get_bin_user</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">bin_dir </span><span class="s2">= </span><span class="s1">get_bin_prefix</span><span class="s2">()</span>

        <span class="s6"># find distutils scripts= scripts</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">script </span><span class="s0">in </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">iter_distutils_script_names</span><span class="s2">():</span>
                <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">bin_dir</span><span class="s2">, </span><span class="s1">script</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">WINDOWS</span><span class="s2">:</span>
                    <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">bin_dir</span><span class="s2">, </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">script</span><span class="s0">}</span><span class="s4">.bat&quot;</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">, </span><span class="s1">NotADirectoryError</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s6"># find console_scripts and gui_scripts</span>
        <span class="s0">def </span><span class="s1">iter_scripts_to_remove</span><span class="s2">(</span>
            <span class="s1">dist</span><span class="s2">: </span><span class="s1">BaseDistribution</span><span class="s2">,</span>
            <span class="s1">bin_dir</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">entry_point </span><span class="s0">in </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">iter_entry_points</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">entry_point</span><span class="s2">.</span><span class="s1">group </span><span class="s2">== </span><span class="s4">&quot;console_scripts&quot;</span><span class="s2">:</span>
                    <span class="s0">yield from </span><span class="s1">_script_names</span><span class="s2">(</span><span class="s1">bin_dir</span><span class="s2">, </span><span class="s1">entry_point</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">entry_point</span><span class="s2">.</span><span class="s1">group </span><span class="s2">== </span><span class="s4">&quot;gui_scripts&quot;</span><span class="s2">:</span>
                    <span class="s0">yield from </span><span class="s1">_script_names</span><span class="s2">(</span><span class="s1">bin_dir</span><span class="s2">, </span><span class="s1">entry_point</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">iter_scripts_to_remove</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">bin_dir</span><span class="s2">):</span>
            <span class="s1">paths_to_remove</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">paths_to_remove</span>


<span class="s0">class </span><span class="s1">UninstallPthEntries</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pth_file</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file </span><span class="s2">= </span><span class="s1">pth_file</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entries</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_saved_lines</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">List</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">]] = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">entry </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normcase</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>
        <span class="s6"># On Windows, os.path.normcase converts the entry to use</span>
        <span class="s6"># backslashes.  This is correct for entries that describe absolute</span>
        <span class="s6"># paths outside of site-packages, but all the others use forward</span>
        <span class="s6"># slashes.</span>
        <span class="s6"># os.path.splitdrive is used instead of os.path.isabs because isabs</span>
        <span class="s6"># treats non-absolute paths with drive letter markings like c:foo\bar</span>
        <span class="s6"># as absolute paths. It also does not recognize UNC paths if they don't</span>
        <span class="s6"># have more than &quot;\\sever\share&quot;. Valid examples: &quot;\\server\share\&quot; or</span>
        <span class="s6"># &quot;\\server\share\folder&quot;.</span>
        <span class="s0">if </span><span class="s1">WINDOWS </span><span class="s0">and not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitdrive</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]:</span>
            <span class="s1">entry </span><span class="s2">= </span><span class="s1">entry</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s4">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">entries</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">(</span><span class="s4">&quot;Removing pth entries from %s:&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s6"># If the file doesn't exist, log a warning and return</span>
        <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">):</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;Cannot remove entries from nonexistent file %s&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
            <span class="s6"># windows uses '\r\n' with py3k, but uses '\n' with py2.x</span>
            <span class="s1">lines </span><span class="s2">= </span><span class="s1">fh</span><span class="s2">.</span><span class="s1">readlines</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_saved_lines </span><span class="s2">= </span><span class="s1">lines</span>
        <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\r\n</span><span class="s7">&quot; </span><span class="s0">in </span><span class="s1">line </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">lines</span><span class="s2">):</span>
            <span class="s1">endline </span><span class="s2">= </span><span class="s4">&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">endline </span><span class="s2">= </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span>
        <span class="s6"># handle missing trailing newline</span>
        <span class="s0">if </span><span class="s1">lines </span><span class="s0">and not </span><span class="s1">lines</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">].</span><span class="s1">endswith</span><span class="s2">(</span><span class="s1">endline</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)):</span>
            <span class="s1">lines</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">lines</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] + </span><span class="s1">endline</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">entries</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">logger</span><span class="s2">.</span><span class="s1">verbose</span><span class="s2">(</span><span class="s4">&quot;Removing entry: %s&quot;</span><span class="s2">, </span><span class="s1">entry</span><span class="s2">)</span>
                <span class="s1">lines</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">((</span><span class="s1">entry </span><span class="s2">+ </span><span class="s1">endline</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">))</span>
            <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
                <span class="s0">pass</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s4">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
            <span class="s1">fh</span><span class="s2">.</span><span class="s1">writelines</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">rollback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_saved_lines </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Cannot roll back changes to %s, none were made&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>
            <span class="s0">return False</span>
        <span class="s1">logger</span><span class="s2">.</span><span class="s1">debug</span><span class="s2">(</span><span class="s4">&quot;Rolling %s back to previous state&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">file</span><span class="s2">, </span><span class="s4">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
            <span class="s1">fh</span><span class="s2">.</span><span class="s1">writelines</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_saved_lines</span><span class="s2">)</span>
        <span class="s0">return True</span>
</pre>
</body>
</html>