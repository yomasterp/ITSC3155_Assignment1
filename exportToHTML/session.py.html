<html>
<head>
<title>session.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
session.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;PipSession and supporting code, containing all pip-specific 
network request configuration and behavior. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">email</span><span class="s3">.</span><span class="s1">utils</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">ipaddress</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">mimetypes</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">subprocess</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">TYPE_CHECKING</span><span class="s3">,</span>
    <span class="s1">Any</span><span class="s3">,</span>
    <span class="s1">Dict</span><span class="s3">,</span>
    <span class="s1">Generator</span><span class="s3">,</span>
    <span class="s1">List</span><span class="s3">,</span>
    <span class="s1">Mapping</span><span class="s3">,</span>
    <span class="s1">Optional</span><span class="s3">,</span>
    <span class="s1">Sequence</span><span class="s3">,</span>
    <span class="s1">Tuple</span><span class="s3">,</span>
    <span class="s1">Union</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor </span><span class="s2">import </span><span class="s1">requests</span><span class="s3">, </span><span class="s1">urllib3</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">cachecontrol </span><span class="s2">import </span><span class="s1">CacheControlAdapter </span><span class="s2">as </span><span class="s1">_BaseCacheControlAdapter</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">requests</span><span class="s3">.</span><span class="s1">adapters </span><span class="s2">import </span><span class="s1">DEFAULT_POOLBLOCK</span><span class="s3">, </span><span class="s1">BaseAdapter</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">requests</span><span class="s3">.</span><span class="s1">adapters </span><span class="s2">import </span><span class="s1">HTTPAdapter </span><span class="s2">as </span><span class="s1">_BaseHTTPAdapter</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">requests</span><span class="s3">.</span><span class="s1">models </span><span class="s2">import </span><span class="s1">PreparedRequest</span><span class="s3">, </span><span class="s1">Response</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">requests</span><span class="s3">.</span><span class="s1">structures </span><span class="s2">import </span><span class="s1">CaseInsensitiveDict</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">urllib3</span><span class="s3">.</span><span class="s1">connectionpool </span><span class="s2">import </span><span class="s1">ConnectionPool</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">urllib3</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">InsecureRequestWarning</span>

<span class="s2">from </span><span class="s1">pip </span><span class="s2">import </span><span class="s1">__version__</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">metadata </span><span class="s2">import </span><span class="s1">get_default_environment</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">models</span><span class="s3">.</span><span class="s1">link </span><span class="s2">import </span><span class="s1">Link</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">network</span><span class="s3">.</span><span class="s1">auth </span><span class="s2">import </span><span class="s1">MultiDomainBasicAuth</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">network</span><span class="s3">.</span><span class="s1">cache </span><span class="s2">import </span><span class="s1">SafeFileCache</span>

<span class="s4"># Import ssl from compat so the initial import occurs in only one place.</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">compat </span><span class="s2">import </span><span class="s1">has_tls</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">glibc </span><span class="s2">import </span><span class="s1">libc_ver</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">misc </span><span class="s2">import </span><span class="s1">build_url_from_netloc</span><span class="s3">, </span><span class="s1">parse_netloc</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">urls </span><span class="s2">import </span><span class="s1">url_to_path</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">ssl </span><span class="s2">import </span><span class="s1">SSLContext</span>

    <span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor</span><span class="s3">.</span><span class="s1">urllib3</span><span class="s3">.</span><span class="s1">poolmanager </span><span class="s2">import </span><span class="s1">PoolManager</span>


<span class="s1">logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>

<span class="s1">SecureOrigin </span><span class="s3">= </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]]</span>


<span class="s4"># Ignore warning raised when using --trusted-host.</span>
<span class="s1">warnings</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s5">&quot;ignore&quot;</span><span class="s3">, </span><span class="s1">category</span><span class="s3">=</span><span class="s1">InsecureRequestWarning</span><span class="s3">)</span>


<span class="s1">SECURE_ORIGINS</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">SecureOrigin</span><span class="s3">] = [</span>
    <span class="s4"># protocol, hostname, port</span>
    <span class="s4"># Taken from Chrome's list of secure origins (See: http://bit.ly/1qrySKC)</span>
    <span class="s3">(</span><span class="s5">&quot;https&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s5">&quot;localhost&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s5">&quot;127.0.0.0/8&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s5">&quot;::1/128&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">&quot;file&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
    <span class="s4"># ssh is always secure.</span>
    <span class="s3">(</span><span class="s5">&quot;ssh&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s5">&quot;*&quot;</span><span class="s3">),</span>
<span class="s3">]</span>


<span class="s4"># These are environment variables present when running under various</span>
<span class="s4"># CI systems.  For each variable, some CI systems that use the variable</span>
<span class="s4"># are indicated.  The collection was chosen so that for each of a number</span>
<span class="s4"># of popular systems, at least one of the environment variables is used.</span>
<span class="s4"># This list is used to provide some indication of and lower bound for</span>
<span class="s4"># CI traffic to PyPI.  Thus, it is okay if the list is not comprehensive.</span>
<span class="s4"># For more background, see: https://github.com/pypa/pip/issues/5499</span>
<span class="s1">CI_ENVIRONMENT_VARIABLES </span><span class="s3">= (</span>
    <span class="s4"># Azure Pipelines</span>
    <span class="s5">&quot;BUILD_BUILDID&quot;</span><span class="s3">,</span>
    <span class="s4"># Jenkins</span>
    <span class="s5">&quot;BUILD_ID&quot;</span><span class="s3">,</span>
    <span class="s4"># AppVeyor, CircleCI, Codeship, Gitlab CI, Shippable, Travis CI</span>
    <span class="s5">&quot;CI&quot;</span><span class="s3">,</span>
    <span class="s4"># Explicit environment variable.</span>
    <span class="s5">&quot;PIP_IS_CI&quot;</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">looks_like_ci</span><span class="s3">() </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Return whether it looks like pip is running under CI. 
    &quot;&quot;&quot;</span>
    <span class="s4"># We don't use the method of checking for a tty (e.g. using isatty())</span>
    <span class="s4"># because some CI systems mimic a tty (e.g. Travis CI).  Thus that</span>
    <span class="s4"># method doesn't provide definitive information in either direction.</span>
    <span class="s2">return </span><span class="s1">any</span><span class="s3">(</span><span class="s1">name </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">CI_ENVIRONMENT_VARIABLES</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">user_agent</span><span class="s3">() </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Return a string representing the user agent. 
    &quot;&quot;&quot;</span>
    <span class="s1">data</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">] = {</span>
        <span class="s5">&quot;installer&quot;</span><span class="s3">: {</span><span class="s5">&quot;name&quot;</span><span class="s3">: </span><span class="s5">&quot;pip&quot;</span><span class="s3">, </span><span class="s5">&quot;version&quot;</span><span class="s3">: </span><span class="s1">__version__</span><span class="s3">},</span>
        <span class="s5">&quot;python&quot;</span><span class="s3">: </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">(),</span>
        <span class="s5">&quot;implementation&quot;</span><span class="s3">: {</span>
            <span class="s5">&quot;name&quot;</span><span class="s3">: </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_implementation</span><span class="s3">(),</span>
        <span class="s3">},</span>
    <span class="s3">}</span>

    <span class="s2">if </span><span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;name&quot;</span><span class="s3">] == </span><span class="s5">&quot;CPython&quot;</span><span class="s3">:</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;version&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">()</span>
    <span class="s2">elif </span><span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;name&quot;</span><span class="s3">] == </span><span class="s5">&quot;PyPy&quot;</span><span class="s3">:</span>
        <span class="s1">pypy_version_info </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">pypy_version_info  </span><span class="s4"># type: ignore</span>
        <span class="s2">if </span><span class="s1">pypy_version_info</span><span class="s3">.</span><span class="s1">releaselevel </span><span class="s3">== </span><span class="s5">&quot;final&quot;</span><span class="s3">:</span>
            <span class="s1">pypy_version_info </span><span class="s3">= </span><span class="s1">pypy_version_info</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">]</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;version&quot;</span><span class="s3">] = </span><span class="s5">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">str</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">pypy_version_info</span><span class="s3">]</span>
        <span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;name&quot;</span><span class="s3">] == </span><span class="s5">&quot;Jython&quot;</span><span class="s3">:</span>
        <span class="s4"># Complete Guess</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;version&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">()</span>
    <span class="s2">elif </span><span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;name&quot;</span><span class="s3">] == </span><span class="s5">&quot;IronPython&quot;</span><span class="s3">:</span>
        <span class="s4"># Complete Guess</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;implementation&quot;</span><span class="s3">][</span><span class="s5">&quot;version&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;linux&quot;</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_vendor </span><span class="s2">import </span><span class="s1">distro</span>

        <span class="s1">linux_distribution </span><span class="s3">= </span><span class="s1">distro</span><span class="s3">.</span><span class="s1">name</span><span class="s3">(), </span><span class="s1">distro</span><span class="s3">.</span><span class="s1">version</span><span class="s3">(), </span><span class="s1">distro</span><span class="s3">.</span><span class="s1">codename</span><span class="s3">()</span>
        <span class="s1">distro_infos</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">] = </span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">filter</span><span class="s3">(</span>
                <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">[</span><span class="s6">1</span><span class="s3">],</span>
                <span class="s1">zip</span><span class="s3">([</span><span class="s5">&quot;name&quot;</span><span class="s3">, </span><span class="s5">&quot;version&quot;</span><span class="s3">, </span><span class="s5">&quot;id&quot;</span><span class="s3">], </span><span class="s1">linux_distribution</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">libc </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
            <span class="s1">filter</span><span class="s3">(</span>
                <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">[</span><span class="s6">1</span><span class="s3">],</span>
                <span class="s1">zip</span><span class="s3">([</span><span class="s5">&quot;lib&quot;</span><span class="s3">, </span><span class="s5">&quot;version&quot;</span><span class="s3">], </span><span class="s1">libc_ver</span><span class="s3">()),</span>
            <span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">libc</span><span class="s3">:</span>
            <span class="s1">distro_infos</span><span class="s3">[</span><span class="s5">&quot;libc&quot;</span><span class="s3">] = </span><span class="s1">libc</span>
        <span class="s2">if </span><span class="s1">distro_infos</span><span class="s3">:</span>
            <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;distro&quot;</span><span class="s3">] = </span><span class="s1">distro_infos</span>

    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;darwin&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">mac_ver</span><span class="s3">()[</span><span class="s6">0</span><span class="s3">]:</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;distro&quot;</span><span class="s3">] = {</span><span class="s5">&quot;name&quot;</span><span class="s3">: </span><span class="s5">&quot;macOS&quot;</span><span class="s3">, </span><span class="s5">&quot;version&quot;</span><span class="s3">: </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">mac_ver</span><span class="s3">()[</span><span class="s6">0</span><span class="s3">]}</span>

    <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">system</span><span class="s3">():</span>
        <span class="s1">data</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;system&quot;</span><span class="s3">, {})[</span><span class="s5">&quot;name&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">system</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">release</span><span class="s3">():</span>
        <span class="s1">data</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;system&quot;</span><span class="s3">, {})[</span><span class="s5">&quot;release&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">release</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">machine</span><span class="s3">():</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;cpu&quot;</span><span class="s3">] = </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">machine</span><span class="s3">()</span>

    <span class="s2">if </span><span class="s1">has_tls</span><span class="s3">():</span>
        <span class="s2">import </span><span class="s1">_ssl </span><span class="s2">as </span><span class="s1">ssl</span>

        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;openssl_version&quot;</span><span class="s3">] = </span><span class="s1">ssl</span><span class="s3">.</span><span class="s1">OPENSSL_VERSION</span>

    <span class="s1">setuptools_dist </span><span class="s3">= </span><span class="s1">get_default_environment</span><span class="s3">().</span><span class="s1">get_distribution</span><span class="s3">(</span><span class="s5">&quot;setuptools&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">setuptools_dist </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;setuptools_version&quot;</span><span class="s3">] = </span><span class="s1">str</span><span class="s3">(</span><span class="s1">setuptools_dist</span><span class="s3">.</span><span class="s1">version</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">shutil</span><span class="s3">.</span><span class="s1">which</span><span class="s3">(</span><span class="s5">&quot;rustc&quot;</span><span class="s3">) </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s4"># If for any reason `rustc --version` fails, silently ignore it</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">rustc_output </span><span class="s3">= </span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">check_output</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s5">&quot;rustc&quot;</span><span class="s3">, </span><span class="s5">&quot;--version&quot;</span><span class="s3">], </span><span class="s1">stderr</span><span class="s3">=</span><span class="s1">subprocess</span><span class="s3">.</span><span class="s1">STDOUT</span><span class="s3">, </span><span class="s1">timeout</span><span class="s3">=</span><span class="s6">0.5</span>
            <span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">rustc_output</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s7">b&quot;rustc &quot;</span><span class="s3">):</span>
                <span class="s4"># The format of `rustc --version` is:</span>
                <span class="s4"># `b'rustc 1.52.1 (9bc8c42bb 2021-05-09)\n'`</span>
                <span class="s4"># We extract just the middle (1.52.1) part</span>
                <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;rustc_version&quot;</span><span class="s3">] = </span><span class="s1">rustc_output</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s7">b&quot; &quot;</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">decode</span><span class="s3">()</span>

    <span class="s4"># Use None rather than False so as not to give the impression that</span>
    <span class="s4"># pip knows it is not being run under CI.  Rather, it is a null or</span>
    <span class="s4"># inconclusive result.  Also, we include some value rather than no</span>
    <span class="s4"># value to make it easier to know that the check has been run.</span>
    <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;ci&quot;</span><span class="s3">] = </span><span class="s2">True if </span><span class="s1">looks_like_ci</span><span class="s3">() </span><span class="s2">else None</span>

    <span class="s1">user_data </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;PIP_USER_AGENT_USER_DATA&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">user_data </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s5">&quot;user_data&quot;</span><span class="s3">] = </span><span class="s1">user_data</span>

    <span class="s2">return </span><span class="s5">&quot;{data[installer][name]}/{data[installer][version]} {json}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
        <span class="s1">data</span><span class="s3">=</span><span class="s1">data</span><span class="s3">,</span>
        <span class="s1">json</span><span class="s3">=</span><span class="s1">json</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">separators</span><span class="s3">=(</span><span class="s5">&quot;,&quot;</span><span class="s3">, </span><span class="s5">&quot;:&quot;</span><span class="s3">), </span><span class="s1">sort_keys</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
    <span class="s3">)</span>


<span class="s2">class </span><span class="s1">LocalFSAdapter</span><span class="s3">(</span><span class="s1">BaseAdapter</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">send</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">request</span><span class="s3">: </span><span class="s1">PreparedRequest</span><span class="s3">,</span>
        <span class="s1">stream</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">timeout</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]]] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">verify</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">, </span><span class="s1">str</span><span class="s3">] = </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cert</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">proxies</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Response</span><span class="s3">:</span>
        <span class="s1">pathname </span><span class="s3">= </span><span class="s1">url_to_path</span><span class="s3">(</span><span class="s1">request</span><span class="s3">.</span><span class="s1">url</span><span class="s3">)</span>

        <span class="s1">resp </span><span class="s3">= </span><span class="s1">Response</span><span class="s3">()</span>
        <span class="s1">resp</span><span class="s3">.</span><span class="s1">status_code </span><span class="s3">= </span><span class="s6">200</span>
        <span class="s1">resp</span><span class="s3">.</span><span class="s1">url </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">url</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">stats </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">(</span><span class="s1">pathname</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">exc</span><span class="s3">:</span>
            <span class="s4"># format the exception raised as a io.BytesIO object,</span>
            <span class="s4"># to return a better error message:</span>
            <span class="s1">resp</span><span class="s3">.</span><span class="s1">status_code </span><span class="s3">= </span><span class="s6">404</span>
            <span class="s1">resp</span><span class="s3">.</span><span class="s1">reason </span><span class="s3">= </span><span class="s1">type</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">).</span><span class="s1">__name__</span>
            <span class="s1">resp</span><span class="s3">.</span><span class="s1">raw </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">resp</span><span class="s3">.</span><span class="s1">reason</span><span class="s2">}</span><span class="s5">: </span><span class="s2">{</span><span class="s1">exc</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">&quot;utf8&quot;</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">modified </span><span class="s3">= </span><span class="s1">email</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">formatdate</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">st_mtime</span><span class="s3">, </span><span class="s1">usegmt</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">content_type </span><span class="s3">= </span><span class="s1">mimetypes</span><span class="s3">.</span><span class="s1">guess_type</span><span class="s3">(</span><span class="s1">pathname</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">or </span><span class="s5">&quot;text/plain&quot;</span>
            <span class="s1">resp</span><span class="s3">.</span><span class="s1">headers </span><span class="s3">= </span><span class="s1">CaseInsensitiveDict</span><span class="s3">(</span>
                <span class="s3">{</span>
                    <span class="s5">&quot;Content-Type&quot;</span><span class="s3">: </span><span class="s1">content_type</span><span class="s3">,</span>
                    <span class="s5">&quot;Content-Length&quot;</span><span class="s3">: </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">st_size</span><span class="s3">,</span>
                    <span class="s5">&quot;Last-Modified&quot;</span><span class="s3">: </span><span class="s1">modified</span><span class="s3">,</span>
                <span class="s3">}</span>
            <span class="s3">)</span>

            <span class="s1">resp</span><span class="s3">.</span><span class="s1">raw </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">pathname</span><span class="s3">, </span><span class="s5">&quot;rb&quot;</span><span class="s3">)</span>
            <span class="s1">resp</span><span class="s3">.</span><span class="s1">close </span><span class="s3">= </span><span class="s1">resp</span><span class="s3">.</span><span class="s1">raw</span><span class="s3">.</span><span class="s1">close</span>

        <span class="s2">return </span><span class="s1">resp</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">_SSLContextAdapterMixin</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Mixin to add the ``ssl_context`` constructor argument to HTTP adapters. 
 
    The additional argument is forwarded directly to the pool manager. This allows us 
    to dynamically decide what SSL store to use at runtime, which is used to implement 
    the optional ``truststore`` backend. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">ssl_context</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s5">&quot;SSLContext&quot;</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_context </span><span class="s3">= </span><span class="s1">ssl_context</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(**</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">init_poolmanager</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">connections</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">maxsize</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">block</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s1">DEFAULT_POOLBLOCK</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">pool_kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;PoolManager&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_context </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">pool_kwargs</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;ssl_context&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_context</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">init_poolmanager</span><span class="s3">(  </span><span class="s4"># type: ignore[misc]</span>
            <span class="s1">connections</span><span class="s3">=</span><span class="s1">connections</span><span class="s3">,</span>
            <span class="s1">maxsize</span><span class="s3">=</span><span class="s1">maxsize</span><span class="s3">,</span>
            <span class="s1">block</span><span class="s3">=</span><span class="s1">block</span><span class="s3">,</span>
            <span class="s3">**</span><span class="s1">pool_kwargs</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">HTTPAdapter</span><span class="s3">(</span><span class="s1">_SSLContextAdapterMixin</span><span class="s3">, </span><span class="s1">_BaseHTTPAdapter</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">CacheControlAdapter</span><span class="s3">(</span><span class="s1">_SSLContextAdapterMixin</span><span class="s3">, </span><span class="s1">_BaseCacheControlAdapter</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">InsecureHTTPAdapter</span><span class="s3">(</span><span class="s1">HTTPAdapter</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">cert_verify</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">conn</span><span class="s3">: </span><span class="s1">ConnectionPool</span><span class="s3">,</span>
        <span class="s1">url</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">verify</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">, </span><span class="s1">str</span><span class="s3">],</span>
        <span class="s1">cert</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]],</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">cert_verify</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">, </span><span class="s1">verify</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">cert</span><span class="s3">=</span><span class="s1">cert</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">InsecureCacheControlAdapter</span><span class="s3">(</span><span class="s1">CacheControlAdapter</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">cert_verify</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">conn</span><span class="s3">: </span><span class="s1">ConnectionPool</span><span class="s3">,</span>
        <span class="s1">url</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">verify</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">, </span><span class="s1">str</span><span class="s3">],</span>
        <span class="s1">cert</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]],</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">cert_verify</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">=</span><span class="s1">conn</span><span class="s3">, </span><span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">, </span><span class="s1">verify</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">cert</span><span class="s3">=</span><span class="s1">cert</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PipSession</span><span class="s3">(</span><span class="s1">requests</span><span class="s3">.</span><span class="s1">Session</span><span class="s3">):</span>
    <span class="s1">timeout</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s3">*</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
        <span class="s1">retries</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">trusted_hosts</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = (),</span>
        <span class="s1">index_urls</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">ssl_context</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s5">&quot;SSLContext&quot;</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        :param trusted_hosts: Domains not to emit warnings for when not using 
            HTTPS. 
        &quot;&quot;&quot;</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s4"># Namespace the attribute with &quot;pip_&quot; just in case to prevent</span>
        <span class="s4"># possible conflicts with the base class.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pip_trusted_origins</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">]]] = []</span>

        <span class="s4"># Attach our User Agent to the request</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s5">&quot;User-Agent&quot;</span><span class="s3">] = </span><span class="s1">user_agent</span><span class="s3">()</span>

        <span class="s4"># Attach our Authentication handler to the session</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">auth </span><span class="s3">= </span><span class="s1">MultiDomainBasicAuth</span><span class="s3">(</span><span class="s1">index_urls</span><span class="s3">=</span><span class="s1">index_urls</span><span class="s3">)</span>

        <span class="s4"># Create our urllib3.Retry instance which will allow us to customize</span>
        <span class="s4"># how we handle retries.</span>
        <span class="s1">retries </span><span class="s3">= </span><span class="s1">urllib3</span><span class="s3">.</span><span class="s1">Retry</span><span class="s3">(</span>
            <span class="s4"># Set the total number of retries that a particular request can</span>
            <span class="s4"># have.</span>
            <span class="s1">total</span><span class="s3">=</span><span class="s1">retries</span><span class="s3">,</span>
            <span class="s4"># A 503 error from PyPI typically means that the Fastly -&gt; Origin</span>
            <span class="s4"># connection got interrupted in some way. A 503 error in general</span>
            <span class="s4"># is typically considered a transient error so we'll go ahead and</span>
            <span class="s4"># retry it.</span>
            <span class="s4"># A 500 may indicate transient error in Amazon S3</span>
            <span class="s4"># A 520 or 527 - may indicate transient error in CloudFlare</span>
            <span class="s1">status_forcelist</span><span class="s3">=[</span><span class="s6">500</span><span class="s3">, </span><span class="s6">503</span><span class="s3">, </span><span class="s6">520</span><span class="s3">, </span><span class="s6">527</span><span class="s3">],</span>
            <span class="s4"># Add a small amount of back off between failed requests in</span>
            <span class="s4"># order to prevent hammering the service.</span>
            <span class="s1">backoff_factor</span><span class="s3">=</span><span class="s6">0.25</span><span class="s3">,</span>
        <span class="s3">)  </span><span class="s4"># type: ignore</span>

        <span class="s4"># Our Insecure HTTPAdapter disables HTTPS validation. It does not</span>
        <span class="s4"># support caching so we'll use it for all http:// URLs.</span>
        <span class="s4"># If caching is disabled, we will also use it for</span>
        <span class="s4"># https:// hosts that we've marked as ignoring</span>
        <span class="s4"># TLS errors for (trusted-hosts).</span>
        <span class="s1">insecure_adapter </span><span class="s3">= </span><span class="s1">InsecureHTTPAdapter</span><span class="s3">(</span><span class="s1">max_retries</span><span class="s3">=</span><span class="s1">retries</span><span class="s3">)</span>

        <span class="s4"># We want to _only_ cache responses on securely fetched origins or when</span>
        <span class="s4"># the host is specified as trusted. We do this because</span>
        <span class="s4"># we can't validate the response of an insecurely/untrusted fetched</span>
        <span class="s4"># origin, and we don't want someone to be able to poison the cache and</span>
        <span class="s4"># require manual eviction from the cache to fix it.</span>
        <span class="s2">if </span><span class="s1">cache</span><span class="s3">:</span>
            <span class="s1">secure_adapter </span><span class="s3">= </span><span class="s1">CacheControlAdapter</span><span class="s3">(</span>
                <span class="s1">cache</span><span class="s3">=</span><span class="s1">SafeFileCache</span><span class="s3">(</span><span class="s1">cache</span><span class="s3">),</span>
                <span class="s1">max_retries</span><span class="s3">=</span><span class="s1">retries</span><span class="s3">,</span>
                <span class="s1">ssl_context</span><span class="s3">=</span><span class="s1">ssl_context</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter </span><span class="s3">= </span><span class="s1">InsecureCacheControlAdapter</span><span class="s3">(</span>
                <span class="s1">cache</span><span class="s3">=</span><span class="s1">SafeFileCache</span><span class="s3">(</span><span class="s1">cache</span><span class="s3">),</span>
                <span class="s1">max_retries</span><span class="s3">=</span><span class="s1">retries</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">secure_adapter </span><span class="s3">= </span><span class="s1">HTTPAdapter</span><span class="s3">(</span><span class="s1">max_retries</span><span class="s3">=</span><span class="s1">retries</span><span class="s3">, </span><span class="s1">ssl_context</span><span class="s3">=</span><span class="s1">ssl_context</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter </span><span class="s3">= </span><span class="s1">insecure_adapter</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span><span class="s5">&quot;https://&quot;</span><span class="s3">, </span><span class="s1">secure_adapter</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span><span class="s5">&quot;http://&quot;</span><span class="s3">, </span><span class="s1">insecure_adapter</span><span class="s3">)</span>

        <span class="s4"># Enable file:// urls</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span><span class="s5">&quot;file://&quot;</span><span class="s3">, </span><span class="s1">LocalFSAdapter</span><span class="s3">())</span>

        <span class="s2">for </span><span class="s1">host </span><span class="s2">in </span><span class="s1">trusted_hosts</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add_trusted_host</span><span class="s3">(</span><span class="s1">host</span><span class="s3">, </span><span class="s1">suppress_logging</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">update_index_urls</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">new_index_urls</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        :param new_index_urls: New index urls to update the authentication 
            handler with. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">auth</span><span class="s3">.</span><span class="s1">index_urls </span><span class="s3">= </span><span class="s1">new_index_urls</span>

    <span class="s2">def </span><span class="s1">add_trusted_host</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">host</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">source</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">, </span><span class="s1">suppress_logging</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        :param host: It is okay to provide a host that has previously been 
            added. 
        :param source: An optional source string, for logging where the host 
            string came from. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">suppress_logging</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;adding trusted host: </span><span class="s2">{</span><span class="s1">host</span><span class="s2">!r}</span><span class="s5">&quot;</span>
            <span class="s2">if </span><span class="s1">source </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">+= </span><span class="s5">f&quot; (from </span><span class="s2">{</span><span class="s1">source</span><span class="s2">}</span><span class="s5">)&quot;</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s1">parsed_host</span><span class="s3">, </span><span class="s1">parsed_port </span><span class="s3">= </span><span class="s1">parse_netloc</span><span class="s3">(</span><span class="s1">host</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">parsed_host </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f&quot;Trusted host URL must include a host part: </span><span class="s2">{</span><span class="s1">host</span><span class="s2">!r}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parsed_host</span><span class="s3">, </span><span class="s1">parsed_port</span><span class="s3">) </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pip_trusted_origins</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">pip_trusted_origins</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">parsed_host</span><span class="s3">, </span><span class="s1">parsed_port</span><span class="s3">))</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span>
            <span class="s1">build_url_from_netloc</span><span class="s3">(</span><span class="s1">host</span><span class="s3">, </span><span class="s1">scheme</span><span class="s3">=</span><span class="s5">&quot;http&quot;</span><span class="s3">) + </span><span class="s5">&quot;/&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span><span class="s1">build_url_from_netloc</span><span class="s3">(</span><span class="s1">host</span><span class="s3">) + </span><span class="s5">&quot;/&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">parsed_port</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span>
                <span class="s1">build_url_from_netloc</span><span class="s3">(</span><span class="s1">host</span><span class="s3">, </span><span class="s1">scheme</span><span class="s3">=</span><span class="s5">&quot;http&quot;</span><span class="s3">) + </span><span class="s5">&quot;:&quot;</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s4"># Mount wildcard ports for the same host.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">mount</span><span class="s3">(</span><span class="s1">build_url_from_netloc</span><span class="s3">(</span><span class="s1">host</span><span class="s3">) + </span><span class="s5">&quot;:&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_trusted_host_adapter</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">iter_secure_origins</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Generator</span><span class="s3">[</span><span class="s1">SecureOrigin</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s2">yield from </span><span class="s1">SECURE_ORIGINS</span>
        <span class="s2">for </span><span class="s1">host</span><span class="s3">, </span><span class="s1">port </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pip_trusted_origins</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s3">(</span><span class="s5">&quot;*&quot;</span><span class="s3">, </span><span class="s1">host</span><span class="s3">, </span><span class="s5">&quot;*&quot; </span><span class="s2">if </span><span class="s1">port </span><span class="s2">is None else </span><span class="s1">port</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">is_secure_origin</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">location</span><span class="s3">: </span><span class="s1">Link</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s4"># Determine if this url used a secure transport mechanism</span>
        <span class="s1">parsed </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">location</span><span class="s3">))</span>
        <span class="s1">origin_protocol</span><span class="s3">, </span><span class="s1">origin_host</span><span class="s3">, </span><span class="s1">origin_port </span><span class="s3">= (</span>
            <span class="s1">parsed</span><span class="s3">.</span><span class="s1">scheme</span><span class="s3">,</span>
            <span class="s1">parsed</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">,</span>
            <span class="s1">parsed</span><span class="s3">.</span><span class="s1">port</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s4"># The protocol to use to see if the protocol matches.</span>
        <span class="s4"># Don't count the repository type as part of the protocol: in</span>
        <span class="s4"># cases such as &quot;git+ssh&quot;, only use &quot;ssh&quot;. (I.e., Only verify against</span>
        <span class="s4"># the last scheme.)</span>
        <span class="s1">origin_protocol </span><span class="s3">= </span><span class="s1">origin_protocol</span><span class="s3">.</span><span class="s1">rsplit</span><span class="s3">(</span><span class="s5">&quot;+&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)[-</span><span class="s6">1</span><span class="s3">]</span>

        <span class="s4"># Determine if our origin is a secure origin by looking through our</span>
        <span class="s4"># hardcoded list of secure origins, as well as any additional ones</span>
        <span class="s4"># configured on this PackageFinder instance.</span>
        <span class="s2">for </span><span class="s1">secure_origin </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">iter_secure_origins</span><span class="s3">():</span>
            <span class="s1">secure_protocol</span><span class="s3">, </span><span class="s1">secure_host</span><span class="s3">, </span><span class="s1">secure_port </span><span class="s3">= </span><span class="s1">secure_origin</span>
            <span class="s2">if </span><span class="s1">origin_protocol </span><span class="s3">!= </span><span class="s1">secure_protocol </span><span class="s2">and </span><span class="s1">secure_protocol </span><span class="s3">!= </span><span class="s5">&quot;*&quot;</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">addr </span><span class="s3">= </span><span class="s1">ipaddress</span><span class="s3">.</span><span class="s1">ip_address</span><span class="s3">(</span><span class="s1">origin_host </span><span class="s2">or </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
                <span class="s1">network </span><span class="s3">= </span><span class="s1">ipaddress</span><span class="s3">.</span><span class="s1">ip_network</span><span class="s3">(</span><span class="s1">secure_host</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s4"># We don't have both a valid address or a valid network, so</span>
                <span class="s4"># we'll check this origin against hostnames.</span>
                <span class="s2">if </span><span class="s3">(</span>
                    <span class="s1">origin_host</span>
                    <span class="s2">and </span><span class="s1">origin_host</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() != </span><span class="s1">secure_host</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
                    <span class="s2">and </span><span class="s1">secure_host </span><span class="s3">!= </span><span class="s5">&quot;*&quot;</span>
                <span class="s3">):</span>
                    <span class="s2">continue</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s4"># We have a valid address and network, so see if the address</span>
                <span class="s4"># is contained within the network.</span>
                <span class="s2">if </span><span class="s1">addr </span><span class="s2">not in </span><span class="s1">network</span><span class="s3">:</span>
                    <span class="s2">continue</span>

            <span class="s4"># Check to see if the port matches.</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">origin_port </span><span class="s3">!= </span><span class="s1">secure_port</span>
                <span class="s2">and </span><span class="s1">secure_port </span><span class="s3">!= </span><span class="s5">&quot;*&quot;</span>
                <span class="s2">and </span><span class="s1">secure_port </span><span class="s2">is not None</span>
            <span class="s3">):</span>
                <span class="s2">continue</span>

            <span class="s4"># If we've gotten here, then this origin matches the current</span>
            <span class="s4"># secure origin and we should return True</span>
            <span class="s2">return True</span>

        <span class="s4"># If we've gotten to this point, then the origin isn't secure and we</span>
        <span class="s4"># will not accept it as a valid location to search. We will however</span>
        <span class="s4"># log a warning that we are ignoring it.</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">warning</span><span class="s3">(</span>
            <span class="s5">&quot;The repository located at %s is not a trusted or secure host and &quot;</span>
            <span class="s5">&quot;is being ignored. If this repository is available via HTTPS we &quot;</span>
            <span class="s5">&quot;recommend you use HTTPS instead, otherwise you may silence &quot;</span>
            <span class="s5">&quot;this warning and allow it anyway with '--trusted-host %s'.&quot;</span><span class="s3">,</span>
            <span class="s1">origin_host</span><span class="s3">,</span>
            <span class="s1">origin_host</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s2">return False</span>

    <span class="s2">def </span><span class="s1">request</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">url</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; Response</span><span class="s3">:</span>
        <span class="s4"># Allow setting a default timeout on a session</span>
        <span class="s1">kwargs</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;timeout&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">)</span>
        <span class="s4"># Allow setting a default proxies on a session</span>
        <span class="s1">kwargs</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;proxies&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">proxies</span><span class="s3">)</span>

        <span class="s4"># Dispatch the actual request</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">request</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
</pre>
</body>
</html>