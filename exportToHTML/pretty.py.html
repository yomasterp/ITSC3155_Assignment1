<html>
<head>
<title>pretty.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pretty.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">builtins</span>
<span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">dataclasses</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">array </span><span class="s0">import </span><span class="s1">array</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">Counter</span><span class="s2">, </span><span class="s1">UserDict</span><span class="s2">, </span><span class="s1">UserList</span><span class="s2">, </span><span class="s1">defaultdict</span><span class="s2">, </span><span class="s1">deque</span>
<span class="s0">from </span><span class="s1">dataclasses </span><span class="s0">import </span><span class="s1">dataclass</span><span class="s2">, </span><span class="s1">fields</span><span class="s2">, </span><span class="s1">is_dataclass</span>
<span class="s0">from </span><span class="s1">inspect </span><span class="s0">import </span><span class="s1">isclass</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">islice</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">MappingProxyType</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">TYPE_CHECKING</span><span class="s2">,</span>
    <span class="s1">Any</span><span class="s2">,</span>
    <span class="s1">Callable</span><span class="s2">,</span>
    <span class="s1">DefaultDict</span><span class="s2">,</span>
    <span class="s1">Dict</span><span class="s2">,</span>
    <span class="s1">Iterable</span><span class="s2">,</span>
    <span class="s1">List</span><span class="s2">,</span>
    <span class="s1">Optional</span><span class="s2">,</span>
    <span class="s1">Sequence</span><span class="s2">,</span>
    <span class="s1">Set</span><span class="s2">,</span>
    <span class="s1">Tuple</span><span class="s2">,</span>
    <span class="s1">Union</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">rich</span><span class="s2">.</span><span class="s1">repr </span><span class="s0">import </span><span class="s1">RichReprResult</span>

<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">attr </span><span class="s0">as </span><span class="s1">_attr_module</span>

    <span class="s1">_has_attrs </span><span class="s2">= </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">_attr_module</span><span class="s2">, </span><span class="s3">&quot;ib&quot;</span><span class="s2">)</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:  </span><span class="s4"># pragma: no cover</span>
    <span class="s1">_has_attrs </span><span class="s2">= </span><span class="s0">False</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">get_console</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_loop </span><span class="s0">import </span><span class="s1">loop_last</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_pick </span><span class="s0">import </span><span class="s1">pick_bool</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">RichRenderable</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">cells </span><span class="s0">import </span><span class="s1">cell_len</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">highlighter </span><span class="s0">import </span><span class="s1">ReprHighlighter</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">jupyter </span><span class="s0">import </span><span class="s1">JupyterMixin</span><span class="s2">, </span><span class="s1">JupyterRenderable</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">measure </span><span class="s0">import </span><span class="s1">Measurement</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s1">Text</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s2">.</span><span class="s1">console </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Console</span><span class="s2">,</span>
        <span class="s1">ConsoleOptions</span><span class="s2">,</span>
        <span class="s1">HighlighterType</span><span class="s2">,</span>
        <span class="s1">JustifyMethod</span><span class="s2">,</span>
        <span class="s1">OverflowMethod</span><span class="s2">,</span>
        <span class="s1">RenderResult</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_is_attr_object</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Check if an object was created with attrs module.&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">_has_attrs </span><span class="s0">and </span><span class="s1">_attr_module</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_get_attr_fields</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; Sequence</span><span class="s2">[</span><span class="s3">&quot;_attr_module.Attribute[Any]&quot;</span><span class="s2">]:</span>
    <span class="s5">&quot;&quot;&quot;Get fields for an attrs object.&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">_attr_module</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)) </span><span class="s0">if </span><span class="s1">_has_attrs </span><span class="s0">else </span><span class="s2">[]</span>


<span class="s0">def </span><span class="s1">_is_dataclass_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Check if an instance of a dataclass contains the default repr. 
 
    Args: 
        obj (object): A dataclass instance. 
 
    Returns: 
        bool: True if the default repr is used, False if there is a custom repr. 
    &quot;&quot;&quot;</span>
    <span class="s4"># Digging in to a lot of internals here</span>
    <span class="s4"># Catching all exceptions in case something is missing on a non CPython implementation</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__repr__</span><span class="s2">.</span><span class="s1">__code__</span><span class="s2">.</span><span class="s1">co_filename </span><span class="s2">== </span><span class="s1">dataclasses</span><span class="s2">.</span><span class="s1">__file__</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:  </span><span class="s4"># pragma: no coverage</span>
        <span class="s0">return False</span>


<span class="s1">_dummy_namedtuple </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s3">&quot;_dummy_namedtuple&quot;</span><span class="s2">, [])</span>


<span class="s0">def </span><span class="s1">_has_default_namedtuple_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Check if an instance of namedtuple contains the default repr 
 
    Args: 
        obj (object): A namedtuple 
 
    Returns: 
        bool: True if the default repr is used, False if there's a custom repr. 
    &quot;&quot;&quot;</span>
    <span class="s1">obj_file </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">obj_file </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">getfile</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__repr__</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s4"># OSError handles case where object is defined in __main__ scope, e.g. REPL - no filename available.</span>
        <span class="s4"># TypeError trapped defensively, in case of object without filename slips through.</span>
        <span class="s0">pass</span>
    <span class="s1">default_repr_file </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">getfile</span><span class="s2">(</span><span class="s1">_dummy_namedtuple</span><span class="s2">.</span><span class="s1">__repr__</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">obj_file </span><span class="s2">== </span><span class="s1">default_repr_file</span>


<span class="s0">def </span><span class="s1">_ipy_display_hook</span><span class="s2">(</span>
    <span class="s1">value</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">,</span>
    <span class="s1">console</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;Console&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">overflow</span><span class="s2">: </span><span class="s3">&quot;OverflowMethod&quot; </span><span class="s2">= </span><span class="s3">&quot;ignore&quot;</span><span class="s2">,</span>
    <span class="s1">crop</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
    <span class="s4"># needed here to prevent circular import:</span>
    <span class="s0">from </span><span class="s2">.</span><span class="s1">console </span><span class="s0">import </span><span class="s1">ConsoleRenderable</span>

    <span class="s4"># always skip rich generated jupyter renderables or None values</span>
    <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">JupyterRenderable</span><span class="s2">) </span><span class="s0">or </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return None</span>

    <span class="s1">console </span><span class="s2">= </span><span class="s1">console </span><span class="s0">or </span><span class="s1">get_console</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">console</span><span class="s2">.</span><span class="s1">capture</span><span class="s2">() </span><span class="s0">as </span><span class="s1">capture</span><span class="s2">:</span>
        <span class="s4"># certain renderables should start on a new line</span>
        <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">ConsoleRenderable</span><span class="s2">):</span>
            <span class="s1">console</span><span class="s2">.</span><span class="s1">line</span><span class="s2">()</span>
        <span class="s1">console</span><span class="s2">.</span><span class="s1">print</span><span class="s2">(</span>
            <span class="s1">value</span>
            <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">RichRenderable</span><span class="s2">)</span>
            <span class="s0">else </span><span class="s1">Pretty</span><span class="s2">(</span>
                <span class="s1">value</span><span class="s2">,</span>
                <span class="s1">overflow</span><span class="s2">=</span><span class="s1">overflow</span><span class="s2">,</span>
                <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
                <span class="s1">max_length</span><span class="s2">=</span><span class="s1">max_length</span><span class="s2">,</span>
                <span class="s1">max_string</span><span class="s2">=</span><span class="s1">max_string</span><span class="s2">,</span>
                <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">max_depth</span><span class="s2">,</span>
                <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">expand_all</span><span class="s2">,</span>
                <span class="s1">margin</span><span class="s2">=</span><span class="s6">12</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s1">crop</span><span class="s2">=</span><span class="s1">crop</span><span class="s2">,</span>
            <span class="s1">new_line_start</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">end</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s4"># strip trailing newline, not usually part of a text repr</span>
    <span class="s4"># I'm not sure if this should be prevented at a lower level</span>
    <span class="s0">return </span><span class="s1">capture</span><span class="s2">.</span><span class="s1">get</span><span class="s2">().</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_safe_isinstance</span><span class="s2">(</span>
    <span class="s1">obj</span><span class="s2">: </span><span class="s1">object</span><span class="s2">, </span><span class="s1">class_or_tuple</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">type</span><span class="s2">, ...]]</span>
<span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;isinstance can fail in rare cases, for example types with no __class__&quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">class_or_tuple</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s0">return False</span>


<span class="s0">def </span><span class="s1">install</span><span class="s2">(</span>
    <span class="s1">console</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;Console&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">overflow</span><span class="s2">: </span><span class="s3">&quot;OverflowMethod&quot; </span><span class="s2">= </span><span class="s3">&quot;ignore&quot;</span><span class="s2">,</span>
    <span class="s1">crop</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Install automatic pretty printing in the Python REPL. 
 
    Args: 
        console (Console, optional): Console instance or ``None`` to use global console. Defaults to None. 
        overflow (Optional[OverflowMethod], optional): Overflow method. Defaults to &quot;ignore&quot;. 
        crop (Optional[bool], optional): Enable cropping of long lines. Defaults to False. 
        indent_guides (bool, optional): Enable indentation guides. Defaults to False. 
        max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to None. 
        max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to None. 
        max_depth (int, optional): Maximum depth of nested data structures, or None for no maximum. Defaults to None. 
        expand_all (bool, optional): Expand all containers. Defaults to False. 
        max_frames (int): Maximum number of frames to show in a traceback, 0 for no maximum. Defaults to 100. 
    &quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">rich </span><span class="s0">import </span><span class="s1">get_console</span>

    <span class="s1">console </span><span class="s2">= </span><span class="s1">console </span><span class="s0">or </span><span class="s1">get_console</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">console </span><span class="s0">is not None</span>

    <span class="s0">def </span><span class="s1">display_hook</span><span class="s2">(</span><span class="s1">value</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Replacement sys.displayhook which prettifies objects with Rich.&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">console </span><span class="s0">is not None</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">_ </span><span class="s2">= </span><span class="s0">None  </span><span class="s4"># type: ignore[attr-defined]</span>
            <span class="s1">console</span><span class="s2">.</span><span class="s1">print</span><span class="s2">(</span>
                <span class="s1">value</span>
                <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">RichRenderable</span><span class="s2">)</span>
                <span class="s0">else </span><span class="s1">Pretty</span><span class="s2">(</span>
                    <span class="s1">value</span><span class="s2">,</span>
                    <span class="s1">overflow</span><span class="s2">=</span><span class="s1">overflow</span><span class="s2">,</span>
                    <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
                    <span class="s1">max_length</span><span class="s2">=</span><span class="s1">max_length</span><span class="s2">,</span>
                    <span class="s1">max_string</span><span class="s2">=</span><span class="s1">max_string</span><span class="s2">,</span>
                    <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">max_depth</span><span class="s2">,</span>
                    <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">expand_all</span><span class="s2">,</span>
                <span class="s2">),</span>
                <span class="s1">crop</span><span class="s2">=</span><span class="s1">crop</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">builtins</span><span class="s2">.</span><span class="s1">_ </span><span class="s2">= </span><span class="s1">value  </span><span class="s4"># type: ignore[attr-defined]</span>

    <span class="s0">if </span><span class="s3">&quot;get_ipython&quot; </span><span class="s0">in </span><span class="s1">globals</span><span class="s2">():</span>
        <span class="s1">ip </span><span class="s2">= </span><span class="s1">get_ipython</span><span class="s2">()  </span><span class="s4"># type: ignore[name-defined]</span>
        <span class="s0">from </span><span class="s1">IPython</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">formatters </span><span class="s0">import </span><span class="s1">BaseFormatter</span>

        <span class="s0">class </span><span class="s1">RichFormatter</span><span class="s2">(</span><span class="s1">BaseFormatter</span><span class="s2">):  </span><span class="s4"># type: ignore[misc]</span>
            <span class="s1">pprint</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span>

            <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; Any</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pprint</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">_ipy_display_hook</span><span class="s2">(</span>
                        <span class="s1">value</span><span class="s2">,</span>
                        <span class="s1">console</span><span class="s2">=</span><span class="s1">get_console</span><span class="s2">(),</span>
                        <span class="s1">overflow</span><span class="s2">=</span><span class="s1">overflow</span><span class="s2">,</span>
                        <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
                        <span class="s1">max_length</span><span class="s2">=</span><span class="s1">max_length</span><span class="s2">,</span>
                        <span class="s1">max_string</span><span class="s2">=</span><span class="s1">max_string</span><span class="s2">,</span>
                        <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">max_depth</span><span class="s2">,</span>
                        <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">expand_all</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s4"># replace plain text formatter with rich formatter</span>
        <span class="s1">rich_formatter </span><span class="s2">= </span><span class="s1">RichFormatter</span><span class="s2">()</span>
        <span class="s1">ip</span><span class="s2">.</span><span class="s1">display_formatter</span><span class="s2">.</span><span class="s1">formatters</span><span class="s2">[</span><span class="s3">&quot;text/plain&quot;</span><span class="s2">] = </span><span class="s1">rich_formatter</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">displayhook </span><span class="s2">= </span><span class="s1">display_hook</span>


<span class="s0">class </span><span class="s1">Pretty</span><span class="s2">(</span><span class="s1">JupyterMixin</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;A rich renderable that pretty prints an object. 
 
    Args: 
        _object (Any): An object to pretty print. 
        highlighter (HighlighterType, optional): Highlighter object to apply to result, or None for ReprHighlighter. Defaults to None. 
        indent_size (int, optional): Number of spaces in indent. Defaults to 4. 
        justify (JustifyMethod, optional): Justify method, or None for default. Defaults to None. 
        overflow (OverflowMethod, optional): Overflow method, or None for default. Defaults to None. 
        no_wrap (Optional[bool], optional): Disable word wrapping. Defaults to False. 
        indent_guides (bool, optional): Enable indentation guides. Defaults to False. 
        max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to None. 
        max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to None. 
        max_depth (int, optional): Maximum depth of nested data structures, or None for no maximum. Defaults to None. 
        expand_all (bool, optional): Expand all containers. Defaults to False. 
        margin (int, optional): Subtrace a margin from width to force containers to expand earlier. Defaults to 0. 
        insert_line (bool, optional): Insert a new line if the output has multiple new lines. Defaults to False. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">_object</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">,</span>
        <span class="s1">highlighter</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;HighlighterType&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">indent_size</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">4</span><span class="s2">,</span>
        <span class="s1">justify</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;JustifyMethod&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">overflow</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;OverflowMethod&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">no_wrap</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">bool</span><span class="s2">] = </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">margin</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">0</span><span class="s2">,</span>
        <span class="s1">insert_line</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_object </span><span class="s2">= </span><span class="s1">_object</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">highlighter </span><span class="s2">= </span><span class="s1">highlighter </span><span class="s0">or </span><span class="s1">ReprHighlighter</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">indent_size </span><span class="s2">= </span><span class="s1">indent_size</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">justify</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;JustifyMethod&quot;</span><span class="s2">] = </span><span class="s1">justify</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">overflow</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;OverflowMethod&quot;</span><span class="s2">] = </span><span class="s1">overflow</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">no_wrap </span><span class="s2">= </span><span class="s1">no_wrap</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">indent_guides </span><span class="s2">= </span><span class="s1">indent_guides</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_length </span><span class="s2">= </span><span class="s1">max_length</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_string </span><span class="s2">= </span><span class="s1">max_string</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_depth </span><span class="s2">= </span><span class="s1">max_depth</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">expand_all </span><span class="s2">= </span><span class="s1">expand_all</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">margin </span><span class="s2">= </span><span class="s1">margin</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">insert_line </span><span class="s2">= </span><span class="s1">insert_line</span>

    <span class="s0">def </span><span class="s1">__rich_console__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">console</span><span class="s2">: </span><span class="s3">&quot;Console&quot;</span><span class="s2">, </span><span class="s1">options</span><span class="s2">: </span><span class="s3">&quot;ConsoleOptions&quot;</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s3">&quot;RenderResult&quot;</span><span class="s2">:</span>
        <span class="s1">pretty_str </span><span class="s2">= </span><span class="s1">pretty_repr</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_object</span><span class="s2">,</span>
            <span class="s1">max_width</span><span class="s2">=</span><span class="s1">options</span><span class="s2">.</span><span class="s1">max_width </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">margin</span><span class="s2">,</span>
            <span class="s1">indent_size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">indent_size</span><span class="s2">,</span>
            <span class="s1">max_length</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_length</span><span class="s2">,</span>
            <span class="s1">max_string</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_string</span><span class="s2">,</span>
            <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_depth</span><span class="s2">,</span>
            <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">expand_all</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">pretty_text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">from_ansi</span><span class="s2">(</span>
            <span class="s1">pretty_str</span><span class="s2">,</span>
            <span class="s1">justify</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">justify </span><span class="s0">or </span><span class="s1">options</span><span class="s2">.</span><span class="s1">justify</span><span class="s2">,</span>
            <span class="s1">overflow</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">overflow </span><span class="s0">or </span><span class="s1">options</span><span class="s2">.</span><span class="s1">overflow</span><span class="s2">,</span>
            <span class="s1">no_wrap</span><span class="s2">=</span><span class="s1">pick_bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">no_wrap</span><span class="s2">, </span><span class="s1">options</span><span class="s2">.</span><span class="s1">no_wrap</span><span class="s2">),</span>
            <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pretty&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">pretty_text </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">highlighter</span><span class="s2">(</span><span class="s1">pretty_text</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">pretty_text</span>
            <span class="s0">else </span><span class="s1">Text</span><span class="s2">(</span>
                <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_object</span><span class="s2">)</span><span class="s0">}</span><span class="s3">.__repr__ returned empty string&quot;</span><span class="s2">,</span>
                <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;dim italic&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">indent_guides </span><span class="s0">and not </span><span class="s1">options</span><span class="s2">.</span><span class="s1">ascii_only</span><span class="s2">:</span>
            <span class="s1">pretty_text </span><span class="s2">= </span><span class="s1">pretty_text</span><span class="s2">.</span><span class="s1">with_indent_guides</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">indent_size</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;repr.indent&quot;</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">insert_line </span><span class="s0">and </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">pretty_text</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s3">&quot;&quot;</span>
        <span class="s0">yield </span><span class="s1">pretty_text</span>

    <span class="s0">def </span><span class="s1">__rich_measure__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">console</span><span class="s2">: </span><span class="s3">&quot;Console&quot;</span><span class="s2">, </span><span class="s1">options</span><span class="s2">: </span><span class="s3">&quot;ConsoleOptions&quot;</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s3">&quot;Measurement&quot;</span><span class="s2">:</span>
        <span class="s1">pretty_str </span><span class="s2">= </span><span class="s1">pretty_repr</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_object</span><span class="s2">,</span>
            <span class="s1">max_width</span><span class="s2">=</span><span class="s1">options</span><span class="s2">.</span><span class="s1">max_width</span><span class="s2">,</span>
            <span class="s1">indent_size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">indent_size</span><span class="s2">,</span>
            <span class="s1">max_length</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_length</span><span class="s2">,</span>
            <span class="s1">max_string</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_string</span><span class="s2">,</span>
            <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_depth</span><span class="s2">,</span>
            <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">expand_all</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">text_width </span><span class="s2">= (</span>
            <span class="s1">max</span><span class="s2">(</span><span class="s1">cell_len</span><span class="s2">(</span><span class="s1">line</span><span class="s2">) </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">pretty_str</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()) </span><span class="s0">if </span><span class="s1">pretty_str </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">Measurement</span><span class="s2">(</span><span class="s1">text_width</span><span class="s2">, </span><span class="s1">text_width</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_braces_for_defaultdict</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">: </span><span class="s1">DefaultDict</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]) </span><span class="s1">-&gt; Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]:</span>
    <span class="s0">return </span><span class="s2">(</span>
        <span class="s3">f&quot;defaultdict(</span><span class="s0">{</span><span class="s1">_object</span><span class="s2">.</span><span class="s1">default_factory</span><span class="s0">!r}</span><span class="s3">, </span><span class="s0">{{</span><span class="s3">&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;})&quot;</span><span class="s2">,</span>
        <span class="s3">f&quot;defaultdict(</span><span class="s0">{</span><span class="s1">_object</span><span class="s2">.</span><span class="s1">default_factory</span><span class="s0">!r}</span><span class="s3">, </span><span class="s0">{{}}</span><span class="s3">)&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_braces_for_array</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">: </span><span class="s3">&quot;array[Any]&quot;</span><span class="s2">) </span><span class="s1">-&gt; Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]:</span>
    <span class="s0">return </span><span class="s2">(</span><span class="s3">f&quot;array(</span><span class="s0">{</span><span class="s1">_object</span><span class="s2">.</span><span class="s1">typecode</span><span class="s0">!r}</span><span class="s3">, [&quot;</span><span class="s2">, </span><span class="s3">&quot;])&quot;</span><span class="s2">, </span><span class="s3">f&quot;array(</span><span class="s0">{</span><span class="s1">_object</span><span class="s2">.</span><span class="s1">typecode</span><span class="s0">!r}</span><span class="s3">)&quot;</span><span class="s2">)</span>


<span class="s1">_BRACES</span><span class="s2">: </span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">Any</span><span class="s2">], </span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]]] = {</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">_Environ</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;environ({&quot;</span><span class="s2">, </span><span class="s3">&quot;})&quot;</span><span class="s2">, </span><span class="s3">&quot;environ({})&quot;</span><span class="s2">),</span>
    <span class="s1">array</span><span class="s2">: </span><span class="s1">_get_braces_for_array</span><span class="s2">,</span>
    <span class="s1">defaultdict</span><span class="s2">: </span><span class="s1">_get_braces_for_defaultdict</span><span class="s2">,</span>
    <span class="s1">Counter</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;Counter({&quot;</span><span class="s2">, </span><span class="s3">&quot;})&quot;</span><span class="s2">, </span><span class="s3">&quot;Counter()&quot;</span><span class="s2">),</span>
    <span class="s1">deque</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;deque([&quot;</span><span class="s2">, </span><span class="s3">&quot;])&quot;</span><span class="s2">, </span><span class="s3">&quot;deque()&quot;</span><span class="s2">),</span>
    <span class="s1">dict</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;{&quot;</span><span class="s2">, </span><span class="s3">&quot;}&quot;</span><span class="s2">, </span><span class="s3">&quot;{}&quot;</span><span class="s2">),</span>
    <span class="s1">UserDict</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;{&quot;</span><span class="s2">, </span><span class="s3">&quot;}&quot;</span><span class="s2">, </span><span class="s3">&quot;{}&quot;</span><span class="s2">),</span>
    <span class="s1">frozenset</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;frozenset({&quot;</span><span class="s2">, </span><span class="s3">&quot;})&quot;</span><span class="s2">, </span><span class="s3">&quot;frozenset()&quot;</span><span class="s2">),</span>
    <span class="s1">list</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;[&quot;</span><span class="s2">, </span><span class="s3">&quot;]&quot;</span><span class="s2">, </span><span class="s3">&quot;[]&quot;</span><span class="s2">),</span>
    <span class="s1">UserList</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;[&quot;</span><span class="s2">, </span><span class="s3">&quot;]&quot;</span><span class="s2">, </span><span class="s3">&quot;[]&quot;</span><span class="s2">),</span>
    <span class="s1">set</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;{&quot;</span><span class="s2">, </span><span class="s3">&quot;}&quot;</span><span class="s2">, </span><span class="s3">&quot;set()&quot;</span><span class="s2">),</span>
    <span class="s1">tuple</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;(&quot;</span><span class="s2">, </span><span class="s3">&quot;)&quot;</span><span class="s2">, </span><span class="s3">&quot;()&quot;</span><span class="s2">),</span>
    <span class="s1">MappingProxyType</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">_object</span><span class="s2">: (</span><span class="s3">&quot;mappingproxy({&quot;</span><span class="s2">, </span><span class="s3">&quot;})&quot;</span><span class="s2">, </span><span class="s3">&quot;mappingproxy({})&quot;</span><span class="s2">),</span>
<span class="s2">}</span>
<span class="s1">_CONTAINERS </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">_BRACES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
<span class="s1">_MAPPING_CONTAINERS </span><span class="s2">= (</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">_Environ</span><span class="s2">, </span><span class="s1">MappingProxyType</span><span class="s2">, </span><span class="s1">UserDict</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_expandable</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Check if an object may be expanded by pretty print.&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s2">(</span>
        <span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">_CONTAINERS</span><span class="s2">)</span>
        <span class="s0">or </span><span class="s2">(</span><span class="s1">is_dataclass</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>
        <span class="s0">or </span><span class="s2">(</span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;__rich_repr__&quot;</span><span class="s2">))</span>
        <span class="s0">or </span><span class="s1">_is_attr_object</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s2">) </span><span class="s0">and not </span><span class="s1">isclass</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Node</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;A node in a repr tree. May be atomic or a container.&quot;&quot;&quot;</span>

    <span class="s1">key_repr</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">value_repr</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">open_brace</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">close_brace</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">empty</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">last</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">is_tuple</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">is_namedtuple</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">children</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">List</span><span class="s2">[</span><span class="s3">&quot;Node&quot;</span><span class="s2">]] = </span><span class="s0">None</span>
    <span class="s1">key_separator</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;: &quot;</span>
    <span class="s1">separator</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;, &quot;</span>

    <span class="s0">def </span><span class="s1">iter_tokens</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s5">&quot;&quot;&quot;Generate tokens for this node.&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_repr</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_repr</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">key_separator</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value_repr</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">value_repr</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">open_brace</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_tuple </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_namedtuple </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">) == </span><span class="s6">1</span><span class="s2">:</span>
                    <span class="s0">yield from </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">[</span><span class="s6">0</span><span class="s2">].</span><span class="s1">iter_tokens</span><span class="s2">()</span>
                    <span class="s0">yield </span><span class="s3">&quot;,&quot;</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">for </span><span class="s1">child </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">children</span><span class="s2">:</span>
                        <span class="s0">yield from </span><span class="s1">child</span><span class="s2">.</span><span class="s1">iter_tokens</span><span class="s2">()</span>
                        <span class="s0">if not </span><span class="s1">child</span><span class="s2">.</span><span class="s1">last</span><span class="s2">:</span>
                            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">separator</span>
                <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">close_brace</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">empty</span>

    <span class="s0">def </span><span class="s1">check_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">start_length</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Check the length fits within a limit. 
 
        Args: 
            start_length (int): Starting length of the line (indent, prefix, suffix). 
            max_length (int): Maximum length. 
 
        Returns: 
            bool: True if the node can be rendered within max length, otherwise False. 
        &quot;&quot;&quot;</span>
        <span class="s1">total_length </span><span class="s2">= </span><span class="s1">start_length</span>
        <span class="s0">for </span><span class="s1">token </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">iter_tokens</span><span class="s2">():</span>
            <span class="s1">total_length </span><span class="s2">+= </span><span class="s1">cell_len</span><span class="s2">(</span><span class="s1">token</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">total_length </span><span class="s2">&gt; </span><span class="s1">max_length</span><span class="s2">:</span>
                <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s1">repr_text </span><span class="s2">= </span><span class="s3">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">iter_tokens</span><span class="s2">())</span>
        <span class="s0">return </span><span class="s1">repr_text</span>

    <span class="s0">def </span><span class="s1">render</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">max_width</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">80</span><span class="s2">, </span><span class="s1">indent_size</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">4</span><span class="s2">, </span><span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Render the node to a pretty repr. 
 
        Args: 
            max_width (int, optional): Maximum width of the repr. Defaults to 80. 
            indent_size (int, optional): Size of indents. Defaults to 4. 
            expand_all (bool, optional): Expand all levels. Defaults to False. 
 
        Returns: 
            str: A repr string of the original object. 
        &quot;&quot;&quot;</span>
        <span class="s1">lines </span><span class="s2">= [</span><span class="s1">_Line</span><span class="s2">(</span><span class="s1">node</span><span class="s2">=</span><span class="s1">self</span><span class="s2">, </span><span class="s1">is_root</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)]</span>
        <span class="s1">line_no </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s0">while </span><span class="s1">line_no </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">):</span>
            <span class="s1">line </span><span class="s2">= </span><span class="s1">lines</span><span class="s2">[</span><span class="s1">line_no</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">line</span><span class="s2">.</span><span class="s1">expandable </span><span class="s0">and not </span><span class="s1">line</span><span class="s2">.</span><span class="s1">expanded</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">expand_all </span><span class="s0">or not </span><span class="s1">line</span><span class="s2">.</span><span class="s1">check_length</span><span class="s2">(</span><span class="s1">max_width</span><span class="s2">):</span>
                    <span class="s1">lines</span><span class="s2">[</span><span class="s1">line_no </span><span class="s2">: </span><span class="s1">line_no </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">] = </span><span class="s1">line</span><span class="s2">.</span><span class="s1">expand</span><span class="s2">(</span><span class="s1">indent_size</span><span class="s2">)</span>
            <span class="s1">line_no </span><span class="s2">+= </span><span class="s6">1</span>

        <span class="s1">repr_str </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">line</span><span class="s2">) </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">lines</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">repr_str</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">_Line</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;A line in repr output.&quot;&quot;&quot;</span>

    <span class="s1">parent</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;_Line&quot;</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">is_root</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">node</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Node</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">text</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">suffix</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">whitespace</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">expanded</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">last</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">expandable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Check if the line may be expanded.&quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Check this line fits within a given number of cells.&quot;&quot;&quot;</span>
        <span class="s1">start_length </span><span class="s2">= (</span>
            <span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">whitespace</span><span class="s2">) + </span><span class="s1">cell_len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s2">) + </span><span class="s1">cell_len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">suffix</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s0">is not None</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">check_length</span><span class="s2">(</span><span class="s1">start_length</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">expand</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">indent_size</span><span class="s2">: </span><span class="s1">int</span><span class="s2">) </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span><span class="s3">&quot;_Line&quot;</span><span class="s2">]:</span>
        <span class="s5">&quot;&quot;&quot;Expand this line by adding children on their own line.&quot;&quot;&quot;</span>
        <span class="s1">node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">node</span>
        <span class="s0">assert </span><span class="s1">node </span><span class="s0">is not None</span>
        <span class="s1">whitespace </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">whitespace</span>
        <span class="s0">assert </span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span>
        <span class="s0">if </span><span class="s1">node</span><span class="s2">.</span><span class="s1">key_repr</span><span class="s2">:</span>
            <span class="s1">new_line </span><span class="s2">= </span><span class="s0">yield </span><span class="s1">_Line</span><span class="s2">(</span>
                <span class="s1">text</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">node</span><span class="s2">.</span><span class="s1">key_repr</span><span class="s0">}{</span><span class="s1">node</span><span class="s2">.</span><span class="s1">key_separator</span><span class="s0">}{</span><span class="s1">node</span><span class="s2">.</span><span class="s1">open_brace</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">,</span>
                <span class="s1">whitespace</span><span class="s2">=</span><span class="s1">whitespace</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">new_line </span><span class="s2">= </span><span class="s0">yield </span><span class="s1">_Line</span><span class="s2">(</span><span class="s1">text</span><span class="s2">=</span><span class="s1">node</span><span class="s2">.</span><span class="s1">open_brace</span><span class="s2">, </span><span class="s1">whitespace</span><span class="s2">=</span><span class="s1">whitespace</span><span class="s2">)</span>
        <span class="s1">child_whitespace </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">whitespace </span><span class="s2">+ </span><span class="s3">&quot; &quot; </span><span class="s2">* </span><span class="s1">indent_size</span>
        <span class="s1">tuple_of_one </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">is_tuple </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s0">for </span><span class="s1">last</span><span class="s2">, </span><span class="s1">child </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span><span class="s1">node</span><span class="s2">.</span><span class="s1">children</span><span class="s2">):</span>
            <span class="s1">separator </span><span class="s2">= </span><span class="s3">&quot;,&quot; </span><span class="s0">if </span><span class="s1">tuple_of_one </span><span class="s0">else </span><span class="s1">node</span><span class="s2">.</span><span class="s1">separator</span>
            <span class="s1">line </span><span class="s2">= </span><span class="s1">_Line</span><span class="s2">(</span>
                <span class="s1">parent</span><span class="s2">=</span><span class="s1">new_line</span><span class="s2">,</span>
                <span class="s1">node</span><span class="s2">=</span><span class="s1">child</span><span class="s2">,</span>
                <span class="s1">whitespace</span><span class="s2">=</span><span class="s1">child_whitespace</span><span class="s2">,</span>
                <span class="s1">suffix</span><span class="s2">=</span><span class="s1">separator</span><span class="s2">,</span>
                <span class="s1">last</span><span class="s2">=</span><span class="s1">last </span><span class="s0">and not </span><span class="s1">tuple_of_one</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">yield </span><span class="s1">line</span>

        <span class="s0">yield </span><span class="s1">_Line</span><span class="s2">(</span>
            <span class="s1">text</span><span class="s2">=</span><span class="s1">node</span><span class="s2">.</span><span class="s1">close_brace</span><span class="s2">,</span>
            <span class="s1">whitespace</span><span class="s2">=</span><span class="s1">whitespace</span><span class="s2">,</span>
            <span class="s1">suffix</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">suffix</span><span class="s2">,</span>
            <span class="s1">last</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">last</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">last</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">whitespace</span><span class="s0">}{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s0">}{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s0">or </span><span class="s3">''</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">(</span>
                <span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">whitespace</span><span class="s0">}{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">text</span><span class="s0">}{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">node </span><span class="s0">or </span><span class="s3">''</span><span class="s0">}{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">suffix</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">()</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_is_namedtuple</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Checks if an object is most likely a namedtuple. It is possible 
    to craft an object that passes this check and isn't a namedtuple, but 
    there is only a minuscule chance of this happening unintentionally. 
 
    Args: 
        obj (Any): The object to test 
 
    Returns: 
        bool: True if the object is a namedtuple. False otherwise. 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">fields </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;_fields&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s4"># Being very defensive - if we cannot get the attr then its not a namedtuple</span>
        <span class="s0">return False</span>
    <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fields</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">traverse</span><span class="s2">(</span>
    <span class="s1">_object</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">,</span>
    <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Node</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Traverse object and generate a tree. 
 
    Args: 
        _object (Any): Object to be traversed. 
        max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to None. 
        max_string (int, optional): Maximum length of string before truncating, or None to disable truncating. 
            Defaults to None. 
        max_depth (int, optional): Maximum depth of data structures, or None for no maximum. 
            Defaults to None. 
 
    Returns: 
        Node: The root of a tree structure which can be used to render a pretty repr. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">to_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Get repr string for an object, but catch errors.&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">max_string </span><span class="s0">is not None</span>
            <span class="s0">and </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, (</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str</span><span class="s2">))</span>
            <span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) &gt; </span><span class="s1">max_string</span>
        <span class="s2">):</span>
            <span class="s1">truncated </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) - </span><span class="s1">max_string</span>
            <span class="s1">obj_repr </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">[:</span><span class="s1">max_string</span><span class="s2">]</span><span class="s0">!r}</span><span class="s3">+</span><span class="s0">{</span><span class="s1">truncated</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">obj_repr </span><span class="s2">= </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">error</span><span class="s2">:</span>
                <span class="s1">obj_repr </span><span class="s2">= </span><span class="s3">f&quot;&lt;repr-error </span><span class="s0">{</span><span class="s1">str</span><span class="s2">(</span><span class="s1">error</span><span class="s2">)</span><span class="s0">!r}</span><span class="s3">&gt;&quot;</span>
        <span class="s0">return </span><span class="s1">obj_repr</span>

    <span class="s1">visited_ids</span><span class="s2">: </span><span class="s1">Set</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">push_visited </span><span class="s2">= </span><span class="s1">visited_ids</span><span class="s2">.</span><span class="s1">add</span>
    <span class="s1">pop_visited </span><span class="s2">= </span><span class="s1">visited_ids</span><span class="s2">.</span><span class="s1">remove</span>

    <span class="s0">def </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">root</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">0</span><span class="s2">) </span><span class="s1">-&gt; Node</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Walk the object depth first.&quot;&quot;&quot;</span>

        <span class="s1">obj_id </span><span class="s2">= </span><span class="s1">id</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">obj_id </span><span class="s0">in </span><span class="s1">visited_ids</span><span class="s2">:</span>
            <span class="s4"># Recursion detected</span>
            <span class="s0">return </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">&quot;...&quot;</span><span class="s2">)</span>

        <span class="s1">obj_type </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s1">children</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Node</span><span class="s2">]</span>
        <span class="s1">reached_max_depth </span><span class="s2">= </span><span class="s1">max_depth </span><span class="s0">is not None and </span><span class="s1">depth </span><span class="s2">&gt;= </span><span class="s1">max_depth</span>

        <span class="s0">def </span><span class="s1">iter_rich_args</span><span class="s2">(</span><span class="s1">rich_args</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]]]:</span>
            <span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">rich_args</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) == </span><span class="s6">3</span><span class="s2">:</span>
                        <span class="s1">key</span><span class="s2">, </span><span class="s1">child</span><span class="s2">, </span><span class="s1">default </span><span class="s2">= </span><span class="s1">arg</span>
                        <span class="s0">if </span><span class="s1">default </span><span class="s2">== </span><span class="s1">child</span><span class="s2">:</span>
                            <span class="s0">continue</span>
                        <span class="s0">yield </span><span class="s1">key</span><span class="s2">, </span><span class="s1">child</span>
                    <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) == </span><span class="s6">2</span><span class="s2">:</span>
                        <span class="s1">key</span><span class="s2">, </span><span class="s1">child </span><span class="s2">= </span><span class="s1">arg</span>
                        <span class="s0">yield </span><span class="s1">key</span><span class="s2">, </span><span class="s1">child</span>
                    <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) == </span><span class="s6">1</span><span class="s2">:</span>
                        <span class="s0">yield </span><span class="s1">arg</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">arg</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">fake_attributes </span><span class="s2">= </span><span class="s1">hasattr</span><span class="s2">(</span>
                <span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;awehoi234_wdfjwljet234_234wdfoijsdfmmnxpi492&quot;</span>
            <span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
            <span class="s1">fake_attributes </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">rich_repr_result</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">RichReprResult</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s0">if not </span><span class="s1">fake_attributes</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;__rich_repr__&quot;</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">isclass</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">):</span>
                    <span class="s1">rich_repr_result </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__rich_repr__</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
                <span class="s0">pass</span>

        <span class="s0">if </span><span class="s1">rich_repr_result </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">push_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
            <span class="s1">angular </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__rich_repr__</span><span class="s2">, </span><span class="s3">&quot;angular&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">args </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">iter_rich_args</span><span class="s2">(</span><span class="s1">rich_repr_result</span><span class="s2">))</span>
            <span class="s1">class_name </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>

            <span class="s0">if </span><span class="s1">args</span><span class="s2">:</span>
                <span class="s1">children </span><span class="s2">= []</span>
                <span class="s1">append </span><span class="s2">= </span><span class="s1">children</span><span class="s2">.</span><span class="s1">append</span>

                <span class="s0">if </span><span class="s1">reached_max_depth</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">angular</span><span class="s2">:</span>
                        <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">...&gt;&quot;</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">(...)&quot;</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">angular</span><span class="s2">:</span>
                        <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                            <span class="s1">open_brace</span><span class="s2">=</span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">} </span><span class="s3">&quot;</span><span class="s2">,</span>
                            <span class="s1">close_brace</span><span class="s2">=</span><span class="s3">&quot;&gt;&quot;</span><span class="s2">,</span>
                            <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                            <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                            <span class="s1">separator</span><span class="s2">=</span><span class="s3">&quot; &quot;</span><span class="s2">,</span>
                        <span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                            <span class="s1">open_brace</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">(&quot;</span><span class="s2">,</span>
                            <span class="s1">close_brace</span><span class="s2">=</span><span class="s3">&quot;)&quot;</span><span class="s2">,</span>
                            <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                            <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                        <span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">last</span><span class="s2">, </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
                        <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                            <span class="s1">key</span><span class="s2">, </span><span class="s1">child </span><span class="s2">= </span><span class="s1">arg</span>
                            <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                            <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">last</span>
                            <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_repr </span><span class="s2">= </span><span class="s1">key</span>
                            <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_separator </span><span class="s2">= </span><span class="s3">&quot;=&quot;</span>
                            <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                            <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">last</span>
                            <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;&lt;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">&gt;&quot; </span><span class="s0">if </span><span class="s1">angular </span><span class="s0">else </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">()&quot;</span><span class="s2">,</span>
                    <span class="s1">children</span><span class="s2">=[],</span>
                    <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s1">pop_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">_is_attr_object</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">fake_attributes</span><span class="s2">:</span>
            <span class="s1">push_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
            <span class="s1">children </span><span class="s2">= []</span>
            <span class="s1">append </span><span class="s2">= </span><span class="s1">children</span><span class="s2">.</span><span class="s1">append</span>

            <span class="s1">attr_fields </span><span class="s2">= </span><span class="s1">_get_attr_fields</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">attr_fields</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">reached_max_depth</span><span class="s2">:</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">(...)&quot;</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                        <span class="s1">open_brace</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">(&quot;</span><span class="s2">,</span>
                        <span class="s1">close_brace</span><span class="s2">=</span><span class="s3">&quot;)&quot;</span><span class="s2">,</span>
                        <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                        <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                    <span class="s2">)</span>

                    <span class="s0">def </span><span class="s1">iter_attrs</span><span class="s2">() </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span>
                        <span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">Any</span><span class="s2">], </span><span class="s1">str</span><span class="s2">]]]</span>
                    <span class="s2">]:</span>
                        <span class="s5">&quot;&quot;&quot;Iterate over attr fields and values.&quot;&quot;&quot;</span>
                        <span class="s0">for </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">attr_fields</span><span class="s2">:</span>
                            <span class="s0">if </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">repr</span><span class="s2">:</span>
                                <span class="s0">try</span><span class="s2">:</span>
                                    <span class="s1">value </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
                                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">error</span><span class="s2">:</span>
                                    <span class="s4"># Can happen, albeit rarely</span>
                                    <span class="s0">yield </span><span class="s2">(</span><span class="s1">attr</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                                <span class="s0">else</span><span class="s2">:</span>
                                    <span class="s0">yield </span><span class="s2">(</span>
                                        <span class="s1">attr</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
                                        <span class="s1">value</span><span class="s2">,</span>
                                        <span class="s1">attr</span><span class="s2">.</span><span class="s1">repr </span><span class="s0">if </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">attr</span><span class="s2">.</span><span class="s1">repr</span><span class="s2">) </span><span class="s0">else None</span><span class="s2">,</span>
                                    <span class="s2">)</span>

                    <span class="s0">for </span><span class="s1">last</span><span class="s2">, (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repr_callable</span><span class="s2">) </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span><span class="s1">iter_attrs</span><span class="s2">()):</span>
                        <span class="s0">if </span><span class="s1">repr_callable</span><span class="s2">:</span>
                            <span class="s1">child_node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">repr_callable</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)))</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">last</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_repr </span><span class="s2">= </span><span class="s1">name</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_separator </span><span class="s2">= </span><span class="s3">&quot;=&quot;</span>
                        <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">()&quot;</span><span class="s2">, </span><span class="s1">children</span><span class="s2">=[], </span><span class="s1">last</span><span class="s2">=</span><span class="s1">root</span>
                <span class="s2">)</span>
            <span class="s1">pop_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s2">(</span>
            <span class="s1">is_dataclass</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
            <span class="s0">and not </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">type</span><span class="s2">)</span>
            <span class="s0">and not </span><span class="s1">fake_attributes</span>
            <span class="s0">and </span><span class="s1">_is_dataclass_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">push_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
            <span class="s1">children </span><span class="s2">= []</span>
            <span class="s1">append </span><span class="s2">= </span><span class="s1">children</span><span class="s2">.</span><span class="s1">append</span>
            <span class="s0">if </span><span class="s1">reached_max_depth</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">(...)&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">open_brace</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">(&quot;</span><span class="s2">,</span>
                    <span class="s1">close_brace</span><span class="s2">=</span><span class="s3">&quot;)&quot;</span><span class="s2">,</span>
                    <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                    <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                    <span class="s1">empty</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s3">()&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>

                <span class="s0">for </span><span class="s1">last</span><span class="s2">, </span><span class="s1">field </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span>
                    <span class="s1">field </span><span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">fields</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">field</span><span class="s2">.</span><span class="s1">repr</span>
                <span class="s2">):</span>
                    <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span><span class="s2">), </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_repr </span><span class="s2">= </span><span class="s1">field</span><span class="s2">.</span><span class="s1">name</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">last</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_separator </span><span class="s2">= </span><span class="s3">&quot;=&quot;</span>
                    <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>

            <span class="s1">pop_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">_is_namedtuple</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) </span><span class="s0">and </span><span class="s1">_has_default_namedtuple_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s1">push_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
            <span class="s1">class_name </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
            <span class="s0">if </span><span class="s1">reached_max_depth</span><span class="s2">:</span>
                <span class="s4"># If we've reached the max depth, we still show the class name, but not its contents</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">(...)&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">children </span><span class="s2">= []</span>
                <span class="s1">append </span><span class="s2">= </span><span class="s1">children</span><span class="s2">.</span><span class="s1">append</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">open_brace</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">(&quot;</span><span class="s2">,</span>
                    <span class="s1">close_brace</span><span class="s2">=</span><span class="s3">&quot;)&quot;</span><span class="s2">,</span>
                    <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                    <span class="s1">empty</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s3">()&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s0">for </span><span class="s1">last</span><span class="s2">, (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">_asdict</span><span class="s2">().</span><span class="s1">items</span><span class="s2">()):</span>
                    <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_repr </span><span class="s2">= </span><span class="s1">key</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">last</span>
                    <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_separator </span><span class="s2">= </span><span class="s3">&quot;=&quot;</span>
                    <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
            <span class="s1">pop_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">_CONTAINERS</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">container_type </span><span class="s0">in </span><span class="s1">_CONTAINERS</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">container_type</span><span class="s2">):</span>
                    <span class="s1">obj_type </span><span class="s2">= </span><span class="s1">container_type</span>
                    <span class="s0">break</span>

            <span class="s1">push_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>

            <span class="s1">open_brace</span><span class="s2">, </span><span class="s1">close_brace</span><span class="s2">, </span><span class="s1">empty </span><span class="s2">= </span><span class="s1">_BRACES</span><span class="s2">[</span><span class="s1">obj_type</span><span class="s2">](</span><span class="s1">obj</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">reached_max_depth</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">open_brace</span><span class="s0">}</span><span class="s3">...</span><span class="s0">{</span><span class="s1">close_brace</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">obj_type</span><span class="s2">.</span><span class="s1">__repr__ </span><span class="s2">!= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">).</span><span class="s1">__repr__</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s1">to_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">), </span><span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">obj</span><span class="s2">:</span>
                <span class="s1">children </span><span class="s2">= []</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span>
                    <span class="s1">open_brace</span><span class="s2">=</span><span class="s1">open_brace</span><span class="s2">,</span>
                    <span class="s1">close_brace</span><span class="s2">=</span><span class="s1">close_brace</span><span class="s2">,</span>
                    <span class="s1">children</span><span class="s2">=</span><span class="s1">children</span><span class="s2">,</span>
                    <span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">append </span><span class="s2">= </span><span class="s1">children</span><span class="s2">.</span><span class="s1">append</span>
                <span class="s1">num_items </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s1">last_item_index </span><span class="s2">= </span><span class="s1">num_items </span><span class="s2">- </span><span class="s6">1</span>

                <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">_MAPPING_CONTAINERS</span><span class="s2">):</span>
                    <span class="s1">iter_items </span><span class="s2">= </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
                    <span class="s0">if </span><span class="s1">max_length </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">iter_items </span><span class="s2">= </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">iter_items</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">index</span><span class="s2">, (</span><span class="s1">key</span><span class="s2">, </span><span class="s1">child</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">iter_items</span><span class="s2">):</span>
                        <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">key_repr </span><span class="s2">= </span><span class="s1">to_repr</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">index </span><span class="s2">== </span><span class="s1">last_item_index</span>
                        <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">iter_values </span><span class="s2">= </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">max_length </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">iter_values </span><span class="s2">= </span><span class="s1">islice</span><span class="s2">(</span><span class="s1">iter_values</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">child </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">iter_values</span><span class="s2">):</span>
                        <span class="s1">child_node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">=</span><span class="s1">depth </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                        <span class="s1">child_node</span><span class="s2">.</span><span class="s1">last </span><span class="s2">= </span><span class="s1">index </span><span class="s2">== </span><span class="s1">last_item_index</span>
                        <span class="s1">append</span><span class="s2">(</span><span class="s1">child_node</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">max_length </span><span class="s0">is not None and </span><span class="s1">num_items </span><span class="s2">&gt; </span><span class="s1">max_length</span><span class="s2">:</span>
                    <span class="s1">append</span><span class="s2">(</span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s3">f&quot;... +</span><span class="s0">{</span><span class="s1">num_items </span><span class="s2">- </span><span class="s1">max_length</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">last</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">empty</span><span class="s2">=</span><span class="s1">empty</span><span class="s2">, </span><span class="s1">children</span><span class="s2">=[], </span><span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">)</span>

            <span class="s1">pop_visited</span><span class="s2">(</span><span class="s1">obj_id</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">Node</span><span class="s2">(</span><span class="s1">value_repr</span><span class="s2">=</span><span class="s1">to_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">), </span><span class="s1">last</span><span class="s2">=</span><span class="s1">root</span><span class="s2">)</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">is_tuple </span><span class="s2">= </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>
        <span class="s1">node</span><span class="s2">.</span><span class="s1">is_namedtuple </span><span class="s2">= </span><span class="s1">_is_namedtuple</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">node</span>

    <span class="s1">node </span><span class="s2">= </span><span class="s1">_traverse</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">, </span><span class="s1">root</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">node</span>


<span class="s0">def </span><span class="s1">pretty_repr</span><span class="s2">(</span>
    <span class="s1">_object</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">max_width</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">80</span><span class="s2">,</span>
    <span class="s1">indent_size</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">4</span><span class="s2">,</span>
    <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Prettify repr string by expanding on to new lines to fit within a given width. 
 
    Args: 
        _object (Any): Object to repr. 
        max_width (int, optional): Desired maximum width of repr string. Defaults to 80. 
        indent_size (int, optional): Number of spaces to indent. Defaults to 4. 
        max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to None. 
        max_string (int, optional): Maximum length of string before truncating, or None to disable truncating. 
            Defaults to None. 
        max_depth (int, optional): Maximum depth of nested data structure, or None for no depth. 
            Defaults to None. 
        expand_all (bool, optional): Expand all containers regardless of available width. Defaults to False. 
 
    Returns: 
        str: A possibly multi-line representation of the object. 
    &quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">_safe_isinstance</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">, </span><span class="s1">Node</span><span class="s2">):</span>
        <span class="s1">node </span><span class="s2">= </span><span class="s1">_object</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">node </span><span class="s2">= </span><span class="s1">traverse</span><span class="s2">(</span>
            <span class="s1">_object</span><span class="s2">, </span><span class="s1">max_length</span><span class="s2">=</span><span class="s1">max_length</span><span class="s2">, </span><span class="s1">max_string</span><span class="s2">=</span><span class="s1">max_string</span><span class="s2">, </span><span class="s1">max_depth</span><span class="s2">=</span><span class="s1">max_depth</span>
        <span class="s2">)</span>
    <span class="s1">repr_str</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s1">node</span><span class="s2">.</span><span class="s1">render</span><span class="s2">(</span>
        <span class="s1">max_width</span><span class="s2">=</span><span class="s1">max_width</span><span class="s2">, </span><span class="s1">indent_size</span><span class="s2">=</span><span class="s1">indent_size</span><span class="s2">, </span><span class="s1">expand_all</span><span class="s2">=</span><span class="s1">expand_all</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">repr_str</span>


<span class="s0">def </span><span class="s1">pprint</span><span class="s2">(</span>
    <span class="s1">_object</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">console</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s3">&quot;Console&quot;</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">max_length</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_string</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">max_depth</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">expand_all</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;A convenience function for pretty printing. 
 
    Args: 
        _object (Any): Object to pretty print. 
        console (Console, optional): Console instance, or None to use default. Defaults to None. 
        max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to None. 
        max_string (int, optional): Maximum length of strings before truncating, or None to disable. Defaults to None. 
        max_depth (int, optional): Maximum depth for nested data structures, or None for unlimited depth. Defaults to None. 
        indent_guides (bool, optional): Enable indentation guides. Defaults to True. 
        expand_all (bool, optional): Expand all containers. Defaults to False. 
    &quot;&quot;&quot;</span>
    <span class="s1">_console </span><span class="s2">= </span><span class="s1">get_console</span><span class="s2">() </span><span class="s0">if </span><span class="s1">console </span><span class="s0">is None else </span><span class="s1">console</span>
    <span class="s1">_console</span><span class="s2">.</span><span class="s1">print</span><span class="s2">(</span>
        <span class="s1">Pretty</span><span class="s2">(</span>
            <span class="s1">_object</span><span class="s2">,</span>
            <span class="s1">max_length</span><span class="s2">=</span><span class="s1">max_length</span><span class="s2">,</span>
            <span class="s1">max_string</span><span class="s2">=</span><span class="s1">max_string</span><span class="s2">,</span>
            <span class="s1">max_depth</span><span class="s2">=</span><span class="s1">max_depth</span><span class="s2">,</span>
            <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
            <span class="s1">expand_all</span><span class="s2">=</span><span class="s1">expand_all</span><span class="s2">,</span>
            <span class="s1">overflow</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s1">soft_wrap</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:  </span><span class="s4"># pragma: no cover</span>

    <span class="s0">class </span><span class="s1">BrokenRepr</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
            <span class="s6">1 </span><span class="s2">/ </span><span class="s6">0</span>
            <span class="s0">return </span><span class="s3">&quot;this will fail&quot;</span>

    <span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">NamedTuple</span>

    <span class="s0">class </span><span class="s1">StockKeepingUnit</span><span class="s2">(</span><span class="s1">NamedTuple</span><span class="s2">):</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span>
        <span class="s1">description</span><span class="s2">: </span><span class="s1">str</span>
        <span class="s1">price</span><span class="s2">: </span><span class="s1">float</span>
        <span class="s1">category</span><span class="s2">: </span><span class="s1">str</span>
        <span class="s1">reviews</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]</span>

    <span class="s1">d </span><span class="s2">= </span><span class="s1">defaultdict</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">d</span><span class="s2">[</span><span class="s3">&quot;foo&quot;</span><span class="s2">] = </span><span class="s6">5</span>
    <span class="s1">data </span><span class="s2">= {</span>
        <span class="s3">&quot;foo&quot;</span><span class="s2">: [</span>
            <span class="s6">1</span><span class="s2">,</span>
            <span class="s3">&quot;Hello World!&quot;</span><span class="s2">,</span>
            <span class="s6">100.123</span><span class="s2">,</span>
            <span class="s6">323.232</span><span class="s2">,</span>
            <span class="s6">432324.0</span><span class="s2">,</span>
            <span class="s2">{</span><span class="s6">5</span><span class="s2">, </span><span class="s6">6</span><span class="s2">, </span><span class="s6">7</span><span class="s2">, (</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">), </span><span class="s6">8</span><span class="s2">},</span>
        <span class="s2">],</span>
        <span class="s3">&quot;bar&quot;</span><span class="s2">: </span><span class="s1">frozenset</span><span class="s2">({</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">}),</span>
        <span class="s3">&quot;defaultdict&quot;</span><span class="s2">: </span><span class="s1">defaultdict</span><span class="s2">(</span>
            <span class="s1">list</span><span class="s2">, {</span><span class="s3">&quot;crumble&quot;</span><span class="s2">: [</span><span class="s3">&quot;apple&quot;</span><span class="s2">, </span><span class="s3">&quot;rhubarb&quot;</span><span class="s2">, </span><span class="s3">&quot;butter&quot;</span><span class="s2">, </span><span class="s3">&quot;sugar&quot;</span><span class="s2">, </span><span class="s3">&quot;flour&quot;</span><span class="s2">]}</span>
        <span class="s2">),</span>
        <span class="s3">&quot;counter&quot;</span><span class="s2">: </span><span class="s1">Counter</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s3">&quot;apple&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;orange&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;pear&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;kumquat&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;kumquat&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;durian&quot; </span><span class="s2">* </span><span class="s6">100</span><span class="s2">,</span>
            <span class="s2">]</span>
        <span class="s2">),</span>
        <span class="s3">&quot;atomic&quot;</span><span class="s2">: (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s3">&quot;namedtuple&quot;</span><span class="s2">: </span><span class="s1">StockKeepingUnit</span><span class="s2">(</span>
            <span class="s3">&quot;Sparkling British Spring Water&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Carbonated spring water&quot;</span><span class="s2">,</span>
            <span class="s6">0.9</span><span class="s2">,</span>
            <span class="s3">&quot;water&quot;</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s3">&quot;its amazing!&quot;</span><span class="s2">, </span><span class="s3">&quot;its terrible!&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s3">&quot;Broken&quot;</span><span class="s2">: </span><span class="s1">BrokenRepr</span><span class="s2">(),</span>
    <span class="s2">}</span>
    <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;foo&quot;</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)  </span><span class="s4"># type: ignore[attr-defined]</span>

    <span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">rich </span><span class="s0">import </span><span class="s1">print</span>

    <span class="s4"># print(Pretty(data, indent_guides=True, max_string=20))</span>

    <span class="s0">class </span><span class="s1">Thing</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s3">&quot;Hello</span><span class="s0">\x1b</span><span class="s3">[38;5;239m World!&quot;</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s1">Pretty</span><span class="s2">(</span><span class="s1">Thing</span><span class="s2">()))</span>
</pre>
</body>
</html>