<html>
<head>
<title>traceback.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
traceback.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">absolute_import</span>

<span class="s0">import </span><span class="s1">linecache</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">dataclasses </span><span class="s0">import </span><span class="s1">dataclass</span><span class="s2">, </span><span class="s1">field</span>
<span class="s0">from </span><span class="s1">traceback </span><span class="s0">import </span><span class="s1">walk_tb</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">ModuleType</span><span class="s2">, </span><span class="s1">TracebackType</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Any</span><span class="s2">,</span>
    <span class="s1">Callable</span><span class="s2">,</span>
    <span class="s1">Dict</span><span class="s2">,</span>
    <span class="s1">Iterable</span><span class="s2">,</span>
    <span class="s1">List</span><span class="s2">,</span>
    <span class="s1">Optional</span><span class="s2">,</span>
    <span class="s1">Sequence</span><span class="s2">,</span>
    <span class="s1">Tuple</span><span class="s2">,</span>
    <span class="s1">Type</span><span class="s2">,</span>
    <span class="s1">Union</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">lexers </span><span class="s0">import </span><span class="s1">guess_lexer_for_filename</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">token </span><span class="s0">import </span><span class="s1">Comment</span><span class="s2">, </span><span class="s1">Keyword</span><span class="s2">, </span><span class="s1">Name</span><span class="s2">, </span><span class="s1">Number</span><span class="s2">, </span><span class="s1">Operator</span><span class="s2">, </span><span class="s1">String</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">token </span><span class="s0">import </span><span class="s1">Text </span><span class="s0">as </span><span class="s1">TextToken</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">token </span><span class="s0">import </span><span class="s1">Token</span>
<span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">pygments</span><span class="s2">.</span><span class="s1">util </span><span class="s0">import </span><span class="s1">ClassNotFound</span>

<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">pretty</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_loop </span><span class="s0">import </span><span class="s1">loop_last</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">columns </span><span class="s0">import </span><span class="s1">Columns</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">console </span><span class="s0">import </span><span class="s1">Console</span><span class="s2">, </span><span class="s1">ConsoleOptions</span><span class="s2">, </span><span class="s1">ConsoleRenderable</span><span class="s2">, </span><span class="s1">RenderResult</span><span class="s2">, </span><span class="s1">group</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">constrain </span><span class="s0">import </span><span class="s1">Constrain</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">highlighter </span><span class="s0">import </span><span class="s1">RegexHighlighter</span><span class="s2">, </span><span class="s1">ReprHighlighter</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">panel </span><span class="s0">import </span><span class="s1">Panel</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">scope </span><span class="s0">import </span><span class="s1">render_scope</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">style </span><span class="s0">import </span><span class="s1">Style</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">syntax </span><span class="s0">import </span><span class="s1">Syntax</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s1">Text</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">theme </span><span class="s0">import </span><span class="s1">Theme</span>

<span class="s1">WINDOWS </span><span class="s2">= </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">system</span><span class="s2">() == </span><span class="s3">&quot;Windows&quot;</span>

<span class="s1">LOCALS_MAX_LENGTH </span><span class="s2">= </span><span class="s4">10</span>
<span class="s1">LOCALS_MAX_STRING </span><span class="s2">= </span><span class="s4">80</span>


<span class="s0">def </span><span class="s1">install</span><span class="s2">(</span>
    <span class="s2">*,</span>
    <span class="s1">console</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Console</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">width</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s4">100</span><span class="s2">,</span>
    <span class="s1">extra_lines</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">3</span><span class="s2">,</span>
    <span class="s1">theme</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">word_wrap</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">show_locals</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">locals_max_length</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_LENGTH</span><span class="s2">,</span>
    <span class="s1">locals_max_string</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_STRING</span><span class="s2">,</span>
    <span class="s1">locals_hide_dunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">locals_hide_sunder</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">bool</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">suppress</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">ModuleType</span><span class="s2">]] = (),</span>
    <span class="s1">max_frames</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">100</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">[[</span><span class="s1">Type</span><span class="s2">[</span><span class="s1">BaseException</span><span class="s2">], </span><span class="s1">BaseException</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">TracebackType</span><span class="s2">]], </span><span class="s1">Any</span><span class="s2">]:</span>
    <span class="s5">&quot;&quot;&quot;Install a rich traceback handler. 
 
    Once installed, any tracebacks will be printed with syntax highlighting and rich formatting. 
 
 
    Args: 
        console (Optional[Console], optional): Console to write exception to. Default uses internal Console instance. 
        width (Optional[int], optional): Width (in characters) of traceback. Defaults to 100. 
        extra_lines (int, optional): Extra lines of code. Defaults to 3. 
        theme (Optional[str], optional): Pygments theme to use in traceback. Defaults to ``None`` which will pick 
            a theme appropriate for the platform. 
        word_wrap (bool, optional): Enable word wrapping of long lines. Defaults to False. 
        show_locals (bool, optional): Enable display of local variables. Defaults to False. 
        locals_max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to 10. 
        locals_max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to 80. 
        locals_hide_dunder (bool, optional): Hide locals prefixed with double underscore. Defaults to True. 
        locals_hide_sunder (bool, optional): Hide locals prefixed with single underscore. Defaults to False. 
        indent_guides (bool, optional): Enable indent guides in code and locals. Defaults to True. 
        suppress (Sequence[Union[str, ModuleType]]): Optional sequence of modules or paths to exclude from traceback. 
 
    Returns: 
        Callable: The previous exception handler that was replaced. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">traceback_console </span><span class="s2">= </span><span class="s1">Console</span><span class="s2">(</span><span class="s1">stderr</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">if </span><span class="s1">console </span><span class="s0">is None else </span><span class="s1">console</span>

    <span class="s1">locals_hide_sunder </span><span class="s2">= (</span>
        <span class="s0">True</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">traceback_console</span><span class="s2">.</span><span class="s1">is_jupyter </span><span class="s0">and </span><span class="s1">locals_hide_sunder </span><span class="s0">is None</span><span class="s2">)</span>
        <span class="s0">else </span><span class="s1">locals_hide_sunder</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">excepthook</span><span class="s2">(</span>
        <span class="s1">type_</span><span class="s2">: </span><span class="s1">Type</span><span class="s2">[</span><span class="s1">BaseException</span><span class="s2">],</span>
        <span class="s1">value</span><span class="s2">: </span><span class="s1">BaseException</span><span class="s2">,</span>
        <span class="s1">traceback</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">TracebackType</span><span class="s2">],</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">traceback_console</span><span class="s2">.</span><span class="s1">print</span><span class="s2">(</span>
            <span class="s1">Traceback</span><span class="s2">.</span><span class="s1">from_exception</span><span class="s2">(</span>
                <span class="s1">type_</span><span class="s2">,</span>
                <span class="s1">value</span><span class="s2">,</span>
                <span class="s1">traceback</span><span class="s2">,</span>
                <span class="s1">width</span><span class="s2">=</span><span class="s1">width</span><span class="s2">,</span>
                <span class="s1">extra_lines</span><span class="s2">=</span><span class="s1">extra_lines</span><span class="s2">,</span>
                <span class="s1">theme</span><span class="s2">=</span><span class="s1">theme</span><span class="s2">,</span>
                <span class="s1">word_wrap</span><span class="s2">=</span><span class="s1">word_wrap</span><span class="s2">,</span>
                <span class="s1">show_locals</span><span class="s2">=</span><span class="s1">show_locals</span><span class="s2">,</span>
                <span class="s1">locals_max_length</span><span class="s2">=</span><span class="s1">locals_max_length</span><span class="s2">,</span>
                <span class="s1">locals_max_string</span><span class="s2">=</span><span class="s1">locals_max_string</span><span class="s2">,</span>
                <span class="s1">locals_hide_dunder</span><span class="s2">=</span><span class="s1">locals_hide_dunder</span><span class="s2">,</span>
                <span class="s1">locals_hide_sunder</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">locals_hide_sunder</span><span class="s2">),</span>
                <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
                <span class="s1">suppress</span><span class="s2">=</span><span class="s1">suppress</span><span class="s2">,</span>
                <span class="s1">max_frames</span><span class="s2">=</span><span class="s1">max_frames</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">ipy_excepthook_closure</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">tb_data </span><span class="s2">= {}  </span><span class="s6"># store information about showtraceback call</span>
        <span class="s1">default_showtraceback </span><span class="s2">= </span><span class="s1">ip</span><span class="s2">.</span><span class="s1">showtraceback  </span><span class="s6"># keep reference of default traceback</span>

        <span class="s0">def </span><span class="s1">ipy_show_traceback</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s5">&quot;&quot;&quot;wrap the default ip.showtraceback to store info for ip._showtraceback&quot;&quot;&quot;</span>
            <span class="s0">nonlocal </span><span class="s1">tb_data</span>
            <span class="s1">tb_data </span><span class="s2">= </span><span class="s1">kwargs</span>
            <span class="s1">default_showtraceback</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">ipy_display_traceback</span><span class="s2">(</span>
            <span class="s2">*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">is_syntax</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">: </span><span class="s1">Any</span>
        <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s5">&quot;&quot;&quot;Internally called traceback from ip._showtraceback&quot;&quot;&quot;</span>
            <span class="s0">nonlocal </span><span class="s1">tb_data</span>
            <span class="s1">exc_tuple </span><span class="s2">= </span><span class="s1">ip</span><span class="s2">.</span><span class="s1">_get_exc_info</span><span class="s2">()</span>

            <span class="s6"># do not display trace on syntax error</span>
            <span class="s1">tb</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">TracebackType</span><span class="s2">] = </span><span class="s0">None if </span><span class="s1">is_syntax </span><span class="s0">else </span><span class="s1">exc_tuple</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]</span>

            <span class="s6"># determine correct tb_offset</span>
            <span class="s1">compiled </span><span class="s2">= </span><span class="s1">tb_data</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;running_compiled_code&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">tb_offset </span><span class="s2">= </span><span class="s1">tb_data</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;tb_offset&quot;</span><span class="s2">, </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">compiled </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s6"># remove ipython internal frames from trace with tb_offset</span>
            <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">tb_offset</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">tb </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s1">tb </span><span class="s2">= </span><span class="s1">tb</span><span class="s2">.</span><span class="s1">tb_next</span>

            <span class="s1">excepthook</span><span class="s2">(</span><span class="s1">exc_tuple</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">exc_tuple</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">tb</span><span class="s2">)</span>
            <span class="s1">tb_data </span><span class="s2">= {}  </span><span class="s6"># clear data upon usage</span>

        <span class="s6"># replace _showtraceback instead of showtraceback to allow ipython features such as debugging to work</span>
        <span class="s6"># this is also what the ipython docs recommends to modify when subclassing InteractiveShell</span>
        <span class="s1">ip</span><span class="s2">.</span><span class="s1">_showtraceback </span><span class="s2">= </span><span class="s1">ipy_display_traceback</span>
        <span class="s6"># add wrapper to capture tb_data</span>
        <span class="s1">ip</span><span class="s2">.</span><span class="s1">showtraceback </span><span class="s2">= </span><span class="s1">ipy_show_traceback</span>
        <span class="s1">ip</span><span class="s2">.</span><span class="s1">showsyntaxerror </span><span class="s2">= </span><span class="s0">lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">: </span><span class="s1">ipy_display_traceback</span><span class="s2">(</span>
            <span class="s2">*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">is_syntax</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">kwargs</span>
        <span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s6"># if within ipython, use customized traceback</span>
        <span class="s1">ip </span><span class="s2">= </span><span class="s1">get_ipython</span><span class="s2">()  </span><span class="s6"># type: ignore[name-defined]</span>
        <span class="s1">ipy_excepthook_closure</span><span class="s2">(</span><span class="s1">ip</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">excepthook</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s6"># otherwise use default system hook</span>
        <span class="s1">old_excepthook </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">excepthook</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">excepthook </span><span class="s2">= </span><span class="s1">excepthook</span>
        <span class="s0">return </span><span class="s1">old_excepthook</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Frame</span><span class="s2">:</span>
    <span class="s1">filename</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">lineno</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">line</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">locals</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">pretty</span><span class="s2">.</span><span class="s1">Node</span><span class="s2">]] = </span><span class="s0">None</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">_SyntaxError</span><span class="s2">:</span>
    <span class="s1">offset</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">filename</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">line</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">lineno</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">msg</span><span class="s2">: </span><span class="s1">str</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Stack</span><span class="s2">:</span>
    <span class="s1">exc_type</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">exc_value</span><span class="s2">: </span><span class="s1">str</span>
    <span class="s1">syntax_error</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">_SyntaxError</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">is_cause</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">frames</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Frame</span><span class="s2">] = </span><span class="s1">field</span><span class="s2">(</span><span class="s1">default_factory</span><span class="s2">=</span><span class="s1">list</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">dataclass</span>
<span class="s0">class </span><span class="s1">Trace</span><span class="s2">:</span>
    <span class="s1">stacks</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Stack</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">PathHighlighter</span><span class="s2">(</span><span class="s1">RegexHighlighter</span><span class="s2">):</span>
    <span class="s1">highlights </span><span class="s2">= [</span><span class="s3">r&quot;(?P&lt;dim&gt;.*/)(?P&lt;bold&gt;.+)&quot;</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">Traceback</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;A Console renderable that renders a traceback. 
 
    Args: 
        trace (Trace, optional): A `Trace` object produced from `extract`. Defaults to None, which uses 
            the last exception. 
        width (Optional[int], optional): Number of characters used to traceback. Defaults to 100. 
        extra_lines (int, optional): Additional lines of code to render. Defaults to 3. 
        theme (str, optional): Override pygments theme used in traceback. 
        word_wrap (bool, optional): Enable word wrapping of long lines. Defaults to False. 
        show_locals (bool, optional): Enable display of local variables. Defaults to False. 
        indent_guides (bool, optional): Enable indent guides in code and locals. Defaults to True. 
        locals_max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
            Defaults to 10. 
        locals_max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to 80. 
        locals_hide_dunder (bool, optional): Hide locals prefixed with double underscore. Defaults to True. 
        locals_hide_sunder (bool, optional): Hide locals prefixed with single underscore. Defaults to False. 
        suppress (Sequence[Union[str, ModuleType]]): Optional sequence of modules or paths to exclude from traceback. 
        max_frames (int): Maximum number of frames to show in a traceback, 0 for no maximum. Defaults to 100. 
 
    &quot;&quot;&quot;</span>

    <span class="s1">LEXERS </span><span class="s2">= {</span>
        <span class="s3">&quot;&quot;</span><span class="s2">: </span><span class="s3">&quot;text&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;.py&quot;</span><span class="s2">: </span><span class="s3">&quot;python&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;.pxd&quot;</span><span class="s2">: </span><span class="s3">&quot;cython&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;.pyx&quot;</span><span class="s2">: </span><span class="s3">&quot;cython&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;.pxi&quot;</span><span class="s2">: </span><span class="s3">&quot;pyrex&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">trace</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Trace</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">width</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s4">100</span><span class="s2">,</span>
        <span class="s1">extra_lines</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">theme</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">word_wrap</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">show_locals</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">locals_max_length</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_LENGTH</span><span class="s2">,</span>
        <span class="s1">locals_max_string</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_STRING</span><span class="s2">,</span>
        <span class="s1">locals_hide_dunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">locals_hide_sunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">suppress</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">ModuleType</span><span class="s2">]] = (),</span>
        <span class="s1">max_frames</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">100</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">if </span><span class="s1">trace </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">exc_info</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">exc_type </span><span class="s0">is None or </span><span class="s1">exc_value </span><span class="s0">is None or </span><span class="s1">traceback </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                    <span class="s3">&quot;Value for 'trace' required if not called in except: block&quot;</span>
                <span class="s2">)</span>
            <span class="s1">trace </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extract</span><span class="s2">(</span>
                <span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">, </span><span class="s1">show_locals</span><span class="s2">=</span><span class="s1">show_locals</span>
            <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">trace </span><span class="s2">= </span><span class="s1">trace</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">width </span><span class="s2">= </span><span class="s1">width</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extra_lines </span><span class="s2">= </span><span class="s1">extra_lines</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">theme </span><span class="s2">= </span><span class="s1">Syntax</span><span class="s2">.</span><span class="s1">get_theme</span><span class="s2">(</span><span class="s1">theme </span><span class="s0">or </span><span class="s3">&quot;ansi_dark&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">word_wrap </span><span class="s2">= </span><span class="s1">word_wrap</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">show_locals </span><span class="s2">= </span><span class="s1">show_locals</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">indent_guides </span><span class="s2">= </span><span class="s1">indent_guides</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locals_max_length </span><span class="s2">= </span><span class="s1">locals_max_length</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locals_max_string </span><span class="s2">= </span><span class="s1">locals_max_string</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locals_hide_dunder </span><span class="s2">= </span><span class="s1">locals_hide_dunder</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">locals_hide_sunder </span><span class="s2">= </span><span class="s1">locals_hide_sunder</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">suppress</span><span class="s2">: </span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = []</span>
        <span class="s0">for </span><span class="s1">suppress_entity </span><span class="s0">in </span><span class="s1">suppress</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">suppress_entity</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s2">(</span>
                    <span class="s1">suppress_entity</span><span class="s2">.</span><span class="s1">__file__ </span><span class="s0">is not None</span>
                <span class="s2">), </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">suppress_entity</span><span class="s0">!r} </span><span class="s3">must be a module with '__file__' attribute&quot;</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">suppress_entity</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">path </span><span class="s2">= </span><span class="s1">suppress_entity</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">normpath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">))</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">suppress</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">max_frames </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s1">max_frames</span><span class="s2">) </span><span class="s0">if </span><span class="s1">max_frames </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s4">0</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_exception</span><span class="s2">(</span>
        <span class="s1">cls</span><span class="s2">,</span>
        <span class="s1">exc_type</span><span class="s2">: </span><span class="s1">Type</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">],</span>
        <span class="s1">exc_value</span><span class="s2">: </span><span class="s1">BaseException</span><span class="s2">,</span>
        <span class="s1">traceback</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">TracebackType</span><span class="s2">],</span>
        <span class="s2">*,</span>
        <span class="s1">width</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s4">100</span><span class="s2">,</span>
        <span class="s1">extra_lines</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">theme</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">word_wrap</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">show_locals</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">locals_max_length</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_LENGTH</span><span class="s2">,</span>
        <span class="s1">locals_max_string</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_STRING</span><span class="s2">,</span>
        <span class="s1">locals_hide_dunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">locals_hide_sunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">indent_guides</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">suppress</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">ModuleType</span><span class="s2">]] = (),</span>
        <span class="s1">max_frames</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s4">100</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s3">&quot;Traceback&quot;</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Create a traceback from exception info 
 
        Args: 
            exc_type (Type[BaseException]): Exception type. 
            exc_value (BaseException): Exception value. 
            traceback (TracebackType): Python Traceback object. 
            width (Optional[int], optional): Number of characters used to traceback. Defaults to 100. 
            extra_lines (int, optional): Additional lines of code to render. Defaults to 3. 
            theme (str, optional): Override pygments theme used in traceback. 
            word_wrap (bool, optional): Enable word wrapping of long lines. Defaults to False. 
            show_locals (bool, optional): Enable display of local variables. Defaults to False. 
            indent_guides (bool, optional): Enable indent guides in code and locals. Defaults to True. 
            locals_max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
                Defaults to 10. 
            locals_max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to 80. 
            locals_hide_dunder (bool, optional): Hide locals prefixed with double underscore. Defaults to True. 
            locals_hide_sunder (bool, optional): Hide locals prefixed with single underscore. Defaults to False. 
            suppress (Iterable[Union[str, ModuleType]]): Optional sequence of modules or paths to exclude from traceback. 
            max_frames (int): Maximum number of frames to show in a traceback, 0 for no maximum. Defaults to 100. 
 
        Returns: 
            Traceback: A Traceback instance that may be printed. 
        &quot;&quot;&quot;</span>
        <span class="s1">rich_traceback </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">extract</span><span class="s2">(</span>
            <span class="s1">exc_type</span><span class="s2">,</span>
            <span class="s1">exc_value</span><span class="s2">,</span>
            <span class="s1">traceback</span><span class="s2">,</span>
            <span class="s1">show_locals</span><span class="s2">=</span><span class="s1">show_locals</span><span class="s2">,</span>
            <span class="s1">locals_max_length</span><span class="s2">=</span><span class="s1">locals_max_length</span><span class="s2">,</span>
            <span class="s1">locals_max_string</span><span class="s2">=</span><span class="s1">locals_max_string</span><span class="s2">,</span>
            <span class="s1">locals_hide_dunder</span><span class="s2">=</span><span class="s1">locals_hide_dunder</span><span class="s2">,</span>
            <span class="s1">locals_hide_sunder</span><span class="s2">=</span><span class="s1">locals_hide_sunder</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span>
            <span class="s1">rich_traceback</span><span class="s2">,</span>
            <span class="s1">width</span><span class="s2">=</span><span class="s1">width</span><span class="s2">,</span>
            <span class="s1">extra_lines</span><span class="s2">=</span><span class="s1">extra_lines</span><span class="s2">,</span>
            <span class="s1">theme</span><span class="s2">=</span><span class="s1">theme</span><span class="s2">,</span>
            <span class="s1">word_wrap</span><span class="s2">=</span><span class="s1">word_wrap</span><span class="s2">,</span>
            <span class="s1">show_locals</span><span class="s2">=</span><span class="s1">show_locals</span><span class="s2">,</span>
            <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">indent_guides</span><span class="s2">,</span>
            <span class="s1">locals_max_length</span><span class="s2">=</span><span class="s1">locals_max_length</span><span class="s2">,</span>
            <span class="s1">locals_max_string</span><span class="s2">=</span><span class="s1">locals_max_string</span><span class="s2">,</span>
            <span class="s1">locals_hide_dunder</span><span class="s2">=</span><span class="s1">locals_hide_dunder</span><span class="s2">,</span>
            <span class="s1">locals_hide_sunder</span><span class="s2">=</span><span class="s1">locals_hide_sunder</span><span class="s2">,</span>
            <span class="s1">suppress</span><span class="s2">=</span><span class="s1">suppress</span><span class="s2">,</span>
            <span class="s1">max_frames</span><span class="s2">=</span><span class="s1">max_frames</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">extract</span><span class="s2">(</span>
        <span class="s1">cls</span><span class="s2">,</span>
        <span class="s1">exc_type</span><span class="s2">: </span><span class="s1">Type</span><span class="s2">[</span><span class="s1">BaseException</span><span class="s2">],</span>
        <span class="s1">exc_value</span><span class="s2">: </span><span class="s1">BaseException</span><span class="s2">,</span>
        <span class="s1">traceback</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">TracebackType</span><span class="s2">],</span>
        <span class="s2">*,</span>
        <span class="s1">show_locals</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">locals_max_length</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_LENGTH</span><span class="s2">,</span>
        <span class="s1">locals_max_string</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s1">LOCALS_MAX_STRING</span><span class="s2">,</span>
        <span class="s1">locals_hide_dunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">locals_hide_sunder</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; Trace</span><span class="s2">:</span>
        <span class="s5">&quot;&quot;&quot;Extract traceback information. 
 
        Args: 
            exc_type (Type[BaseException]): Exception type. 
            exc_value (BaseException): Exception value. 
            traceback (TracebackType): Python Traceback object. 
            show_locals (bool, optional): Enable display of local variables. Defaults to False. 
            locals_max_length (int, optional): Maximum length of containers before abbreviating, or None for no abbreviation. 
                Defaults to 10. 
            locals_max_string (int, optional): Maximum length of string before truncating, or None to disable. Defaults to 80. 
            locals_hide_dunder (bool, optional): Hide locals prefixed with double underscore. Defaults to True. 
            locals_hide_sunder (bool, optional): Hide locals prefixed with single underscore. Defaults to False. 
 
        Returns: 
            Trace: A Trace instance which you can use to construct a `Traceback`. 
        &quot;&quot;&quot;</span>

        <span class="s1">stacks</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Stack</span><span class="s2">] = []</span>
        <span class="s1">is_cause </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">from </span><span class="s1">pip</span><span class="s2">.</span><span class="s1">_vendor</span><span class="s2">.</span><span class="s1">rich </span><span class="s0">import </span><span class="s1">_IMPORT_CWD</span>

        <span class="s0">def </span><span class="s1">safe_str</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
            <span class="s5">&quot;&quot;&quot;Don't allow exceptions from __str__ to propagate.&quot;&quot;&quot;</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">_object</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s3">&quot;&lt;exception str() failed&gt;&quot;</span>

        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">stack </span><span class="s2">= </span><span class="s1">Stack</span><span class="s2">(</span>
                <span class="s1">exc_type</span><span class="s2">=</span><span class="s1">safe_str</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">),</span>
                <span class="s1">exc_value</span><span class="s2">=</span><span class="s1">safe_str</span><span class="s2">(</span><span class="s1">exc_value</span><span class="s2">),</span>
                <span class="s1">is_cause</span><span class="s2">=</span><span class="s1">is_cause</span><span class="s2">,</span>
            <span class="s2">)</span>

            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">SyntaxError</span><span class="s2">):</span>
                <span class="s1">stack</span><span class="s2">.</span><span class="s1">syntax_error </span><span class="s2">= </span><span class="s1">_SyntaxError</span><span class="s2">(</span>
                    <span class="s1">offset</span><span class="s2">=</span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">offset </span><span class="s0">or </span><span class="s4">0</span><span class="s2">,</span>
                    <span class="s1">filename</span><span class="s2">=</span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">filename </span><span class="s0">or </span><span class="s3">&quot;?&quot;</span><span class="s2">,</span>
                    <span class="s1">lineno</span><span class="s2">=</span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">lineno </span><span class="s0">or </span><span class="s4">0</span><span class="s2">,</span>
                    <span class="s1">line</span><span class="s2">=</span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">text </span><span class="s0">or </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s1">msg</span><span class="s2">=</span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">msg</span><span class="s2">,</span>
                <span class="s2">)</span>

            <span class="s1">stacks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">)</span>
            <span class="s1">append </span><span class="s2">= </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">.</span><span class="s1">append</span>

            <span class="s0">def </span><span class="s1">get_locals</span><span class="s2">(</span>
                <span class="s1">iter_locals</span><span class="s2">: </span><span class="s1">Iterable</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">object</span><span class="s2">]]</span>
            <span class="s2">) </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">object</span><span class="s2">]]:</span>
                <span class="s5">&quot;&quot;&quot;Extract locals from an iterator of key pairs.&quot;&quot;&quot;</span>
                <span class="s0">if not </span><span class="s2">(</span><span class="s1">locals_hide_dunder </span><span class="s0">or </span><span class="s1">locals_hide_sunder</span><span class="s2">):</span>
                    <span class="s0">yield from </span><span class="s1">iter_locals</span>
                    <span class="s0">return</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">iter_locals</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">locals_hide_dunder </span><span class="s0">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;__&quot;</span><span class="s2">):</span>
                        <span class="s0">continue</span>
                    <span class="s0">if </span><span class="s1">locals_hide_sunder </span><span class="s0">and </span><span class="s1">key</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;_&quot;</span><span class="s2">):</span>
                        <span class="s0">continue</span>
                    <span class="s0">yield </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span>

            <span class="s0">for </span><span class="s1">frame_summary</span><span class="s2">, </span><span class="s1">line_no </span><span class="s0">in </span><span class="s1">walk_tb</span><span class="s2">(</span><span class="s1">traceback</span><span class="s2">):</span>
                <span class="s1">filename </span><span class="s2">= </span><span class="s1">frame_summary</span><span class="s2">.</span><span class="s1">f_code</span><span class="s2">.</span><span class="s1">co_filename</span>
                <span class="s0">if </span><span class="s1">filename </span><span class="s0">and not </span><span class="s1">filename</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;&lt;&quot;</span><span class="s2">):</span>
                    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isabs</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">):</span>
                        <span class="s1">filename </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">_IMPORT_CWD</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">frame_summary</span><span class="s2">.</span><span class="s1">f_locals</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;_rich_traceback_omit&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s0">continue</span>

                <span class="s1">frame </span><span class="s2">= </span><span class="s1">Frame</span><span class="s2">(</span>
                    <span class="s1">filename</span><span class="s2">=</span><span class="s1">filename </span><span class="s0">or </span><span class="s3">&quot;?&quot;</span><span class="s2">,</span>
                    <span class="s1">lineno</span><span class="s2">=</span><span class="s1">line_no</span><span class="s2">,</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s1">frame_summary</span><span class="s2">.</span><span class="s1">f_code</span><span class="s2">.</span><span class="s1">co_name</span><span class="s2">,</span>
                    <span class="s1">locals</span><span class="s2">={</span>
                        <span class="s1">key</span><span class="s2">: </span><span class="s1">pretty</span><span class="s2">.</span><span class="s1">traverse</span><span class="s2">(</span>
                            <span class="s1">value</span><span class="s2">,</span>
                            <span class="s1">max_length</span><span class="s2">=</span><span class="s1">locals_max_length</span><span class="s2">,</span>
                            <span class="s1">max_string</span><span class="s2">=</span><span class="s1">locals_max_string</span><span class="s2">,</span>
                        <span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">get_locals</span><span class="s2">(</span><span class="s1">frame_summary</span><span class="s2">.</span><span class="s1">f_locals</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
                    <span class="s2">}</span>
                    <span class="s0">if </span><span class="s1">show_locals</span>
                    <span class="s0">else None</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">append</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">frame_summary</span><span class="s2">.</span><span class="s1">f_locals</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;_rich_traceback_guard&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s0">del </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">[:]</span>

            <span class="s1">cause </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">exc_value</span><span class="s2">, </span><span class="s3">&quot;__cause__&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">cause</span><span class="s2">:</span>
                <span class="s1">exc_type </span><span class="s2">= </span><span class="s1">cause</span><span class="s2">.</span><span class="s1">__class__</span>
                <span class="s1">exc_value </span><span class="s2">= </span><span class="s1">cause</span>
                <span class="s6"># __traceback__ can be None, e.g. for exceptions raised by the</span>
                <span class="s6"># 'multiprocessing' module</span>
                <span class="s1">traceback </span><span class="s2">= </span><span class="s1">cause</span><span class="s2">.</span><span class="s1">__traceback__</span>
                <span class="s1">is_cause </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">continue</span>

            <span class="s1">cause </span><span class="s2">= </span><span class="s1">exc_value</span><span class="s2">.</span><span class="s1">__context__</span>
            <span class="s0">if </span><span class="s1">cause </span><span class="s0">and not </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">exc_value</span><span class="s2">, </span><span class="s3">&quot;__suppress_context__&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                <span class="s1">exc_type </span><span class="s2">= </span><span class="s1">cause</span><span class="s2">.</span><span class="s1">__class__</span>
                <span class="s1">exc_value </span><span class="s2">= </span><span class="s1">cause</span>
                <span class="s1">traceback </span><span class="s2">= </span><span class="s1">cause</span><span class="s2">.</span><span class="s1">__traceback__</span>
                <span class="s1">is_cause </span><span class="s2">= </span><span class="s0">False</span>
                <span class="s0">continue</span>
            <span class="s6"># No cover, code is reached but coverage doesn't recognize it.</span>
            <span class="s0">break  </span><span class="s6"># pragma: no cover</span>

        <span class="s1">trace </span><span class="s2">= </span><span class="s1">Trace</span><span class="s2">(</span><span class="s1">stacks</span><span class="s2">=</span><span class="s1">stacks</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">trace</span>

    <span class="s0">def </span><span class="s1">__rich_console__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">console</span><span class="s2">: </span><span class="s1">Console</span><span class="s2">, </span><span class="s1">options</span><span class="s2">: </span><span class="s1">ConsoleOptions</span>
    <span class="s2">) </span><span class="s1">-&gt; RenderResult</span><span class="s2">:</span>
        <span class="s1">theme </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theme</span>
        <span class="s1">background_style </span><span class="s2">= </span><span class="s1">theme</span><span class="s2">.</span><span class="s1">get_background_style</span><span class="s2">()</span>
        <span class="s1">token_style </span><span class="s2">= </span><span class="s1">theme</span><span class="s2">.</span><span class="s1">get_style_for_token</span>

        <span class="s1">traceback_theme </span><span class="s2">= </span><span class="s1">Theme</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;pretty&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">TextToken</span><span class="s2">),</span>
                <span class="s3">&quot;pygments.text&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Token</span><span class="s2">),</span>
                <span class="s3">&quot;pygments.string&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">String</span><span class="s2">),</span>
                <span class="s3">&quot;pygments.function&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Name</span><span class="s2">.</span><span class="s1">Function</span><span class="s2">),</span>
                <span class="s3">&quot;pygments.number&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Number</span><span class="s2">),</span>
                <span class="s3">&quot;repr.indent&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Comment</span><span class="s2">) + </span><span class="s1">Style</span><span class="s2">(</span><span class="s1">dim</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                <span class="s3">&quot;repr.str&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">String</span><span class="s2">),</span>
                <span class="s3">&quot;repr.brace&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">TextToken</span><span class="s2">) + </span><span class="s1">Style</span><span class="s2">(</span><span class="s1">bold</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                <span class="s3">&quot;repr.number&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Number</span><span class="s2">),</span>
                <span class="s3">&quot;repr.bool_true&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Keyword</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">),</span>
                <span class="s3">&quot;repr.bool_false&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Keyword</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">),</span>
                <span class="s3">&quot;repr.none&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Keyword</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">),</span>
                <span class="s3">&quot;scope.border&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">String</span><span class="s2">.</span><span class="s1">Delimiter</span><span class="s2">),</span>
                <span class="s3">&quot;scope.equals&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Operator</span><span class="s2">),</span>
                <span class="s3">&quot;scope.key&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Name</span><span class="s2">),</span>
                <span class="s3">&quot;scope.key.special&quot;</span><span class="s2">: </span><span class="s1">token_style</span><span class="s2">(</span><span class="s1">Name</span><span class="s2">.</span><span class="s1">Constant</span><span class="s2">) + </span><span class="s1">Style</span><span class="s2">(</span><span class="s1">dim</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">inherit</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">highlighter </span><span class="s2">= </span><span class="s1">ReprHighlighter</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">last</span><span class="s2">, </span><span class="s1">stack </span><span class="s0">in </span><span class="s1">loop_last</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">trace</span><span class="s2">.</span><span class="s1">stacks</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">:</span>
                <span class="s1">stack_renderable</span><span class="s2">: </span><span class="s1">ConsoleRenderable </span><span class="s2">= </span><span class="s1">Panel</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_render_stack</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">),</span>
                    <span class="s1">title</span><span class="s2">=</span><span class="s3">&quot;[traceback.title]Traceback [dim](most recent call last)&quot;</span><span class="s2">,</span>
                    <span class="s1">style</span><span class="s2">=</span><span class="s1">background_style</span><span class="s2">,</span>
                    <span class="s1">border_style</span><span class="s2">=</span><span class="s3">&quot;traceback.border&quot;</span><span class="s2">,</span>
                    <span class="s1">expand</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                    <span class="s1">padding</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                <span class="s2">)</span>
                <span class="s1">stack_renderable </span><span class="s2">= </span><span class="s1">Constrain</span><span class="s2">(</span><span class="s1">stack_renderable</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">console</span><span class="s2">.</span><span class="s1">use_theme</span><span class="s2">(</span><span class="s1">traceback_theme</span><span class="s2">):</span>
                    <span class="s0">yield </span><span class="s1">stack_renderable</span>
            <span class="s0">if </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">syntax_error </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">console</span><span class="s2">.</span><span class="s1">use_theme</span><span class="s2">(</span><span class="s1">traceback_theme</span><span class="s2">):</span>
                    <span class="s0">yield </span><span class="s1">Constrain</span><span class="s2">(</span>
                        <span class="s1">Panel</span><span class="s2">(</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">_render_syntax_error</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">syntax_error</span><span class="s2">),</span>
                            <span class="s1">style</span><span class="s2">=</span><span class="s1">background_style</span><span class="s2">,</span>
                            <span class="s1">border_style</span><span class="s2">=</span><span class="s3">&quot;traceback.border.syntax_error&quot;</span><span class="s2">,</span>
                            <span class="s1">expand</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                            <span class="s1">padding</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s1">width</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">,</span>
                        <span class="s2">),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">exc_type</span><span class="s0">}</span><span class="s3">: &quot;</span><span class="s2">, </span><span class="s3">&quot;traceback.exc_type&quot;</span><span class="s2">),</span>
                    <span class="s1">highlighter</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">msg</span><span class="s2">),</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">exc_value</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">exc_type</span><span class="s0">}</span><span class="s3">: &quot;</span><span class="s2">, </span><span class="s3">&quot;traceback.exc_type&quot;</span><span class="s2">),</span>
                    <span class="s1">highlighter</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">exc_value</span><span class="s2">),</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">((</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">exc_type</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;traceback.exc_type&quot;</span><span class="s2">))</span>

            <span class="s0">if not </span><span class="s1">last</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">stack</span><span class="s2">.</span><span class="s1">is_cause</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">from_markup</span><span class="s2">(</span>
                        <span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">[i]The above exception was the direct cause of the following exception:</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
                    <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">from_markup</span><span class="s2">(</span>
                        <span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">[i]During handling of the above exception, another exception occurred:</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">,</span>
                    <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">group</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">_render_syntax_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">syntax_error</span><span class="s2">: </span><span class="s1">_SyntaxError</span><span class="s2">) </span><span class="s1">-&gt; RenderResult</span><span class="s2">:</span>
        <span class="s1">highlighter </span><span class="s2">= </span><span class="s1">ReprHighlighter</span><span class="s2">()</span>
        <span class="s1">path_highlighter </span><span class="s2">= </span><span class="s1">PathHighlighter</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">!= </span><span class="s3">&quot;&lt;stdin&gt;&quot;</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s3">f&quot; </span><span class="s0">{</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">filename</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;pygments.string&quot;</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">), </span><span class="s3">&quot;pygments.number&quot;</span><span class="s2">),</span>
                    <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s0">yield </span><span class="s1">path_highlighter</span><span class="s2">(</span><span class="s1">text</span><span class="s2">)</span>
        <span class="s1">syntax_error_text </span><span class="s2">= </span><span class="s1">highlighter</span><span class="s2">(</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">line</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">())</span>
        <span class="s1">syntax_error_text</span><span class="s2">.</span><span class="s1">no_wrap </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">syntax_error</span><span class="s2">.</span><span class="s1">offset </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">syntax_error_text</span><span class="s2">))</span>
        <span class="s1">syntax_error_text</span><span class="s2">.</span><span class="s1">stylize</span><span class="s2">(</span><span class="s3">&quot;bold underline&quot;</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s1">syntax_error_text </span><span class="s2">+= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">from_markup</span><span class="s2">(</span>
            <span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot; &quot; </span><span class="s2">* </span><span class="s1">offset </span><span class="s2">+ </span><span class="s3">&quot;[traceback.offset][/]&quot;</span><span class="s2">,</span>
            <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">yield </span><span class="s1">syntax_error_text</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">_guess_lexer</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">code</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s1">ext </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">splitext</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)[-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">if not </span><span class="s1">ext</span><span class="s2">:</span>
            <span class="s6"># No extension, look at first line to see if it is a hashbang</span>
            <span class="s6"># Note, this is an educated guess and not a guarantee</span>
            <span class="s6"># If it fails, the only downside is that the code is highlighted strangely</span>
            <span class="s1">new_line_index </span><span class="s2">= </span><span class="s1">code</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">)</span>
            <span class="s1">first_line </span><span class="s2">= </span><span class="s1">code</span><span class="s2">[:</span><span class="s1">new_line_index</span><span class="s2">] </span><span class="s0">if </span><span class="s1">new_line_index </span><span class="s2">!= -</span><span class="s4">1 </span><span class="s0">else </span><span class="s1">code</span>
            <span class="s0">if </span><span class="s1">first_line</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;#!&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s3">&quot;python&quot; </span><span class="s0">in </span><span class="s1">first_line</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">():</span>
                <span class="s0">return </span><span class="s3">&quot;python&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">LEXERS</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ext</span><span class="s2">) </span><span class="s0">or </span><span class="s1">guess_lexer_for_filename</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">code</span><span class="s2">).</span><span class="s1">name</span>
        <span class="s0">except </span><span class="s1">ClassNotFound</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s3">&quot;text&quot;</span>

    <span class="s2">@</span><span class="s1">group</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">_render_stack</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">: </span><span class="s1">Stack</span><span class="s2">) </span><span class="s1">-&gt; RenderResult</span><span class="s2">:</span>
        <span class="s1">path_highlighter </span><span class="s2">= </span><span class="s1">PathHighlighter</span><span class="s2">()</span>
        <span class="s1">theme </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">theme</span>

        <span class="s0">def </span><span class="s1">read_code</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
            <span class="s5">&quot;&quot;&quot;Read files, and cache results on filename. 
 
            Args: 
                filename (str): Filename to read 
 
            Returns: 
                str: Contents of file 
            &quot;&quot;&quot;</span>
            <span class="s0">return </span><span class="s3">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">linecache</span><span class="s2">.</span><span class="s1">getlines</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">))</span>

        <span class="s0">def </span><span class="s1">render_locals</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">: </span><span class="s1">Frame</span><span class="s2">) </span><span class="s1">-&gt; Iterable</span><span class="s2">[</span><span class="s1">ConsoleRenderable</span><span class="s2">]:</span>
            <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">locals</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s1">render_scope</span><span class="s2">(</span>
                    <span class="s1">frame</span><span class="s2">.</span><span class="s1">locals</span><span class="s2">,</span>
                    <span class="s1">title</span><span class="s2">=</span><span class="s3">&quot;locals&quot;</span><span class="s2">,</span>
                    <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">indent_guides</span><span class="s2">,</span>
                    <span class="s1">max_length</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">locals_max_length</span><span class="s2">,</span>
                    <span class="s1">max_string</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">locals_max_string</span><span class="s2">,</span>
                <span class="s2">)</span>

        <span class="s1">exclude_frames</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">range</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_frames </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">exclude_frames </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">max_frames </span><span class="s2">// </span><span class="s4">2</span><span class="s2">,</span>
                <span class="s1">len</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">max_frames </span><span class="s2">// </span><span class="s4">2</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s1">excluded </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">frame_index</span><span class="s2">, </span><span class="s1">frame </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">stack</span><span class="s2">.</span><span class="s1">frames</span><span class="s2">):</span>

            <span class="s0">if </span><span class="s1">exclude_frames </span><span class="s0">and </span><span class="s1">frame_index </span><span class="s0">in </span><span class="s1">exclude_frames</span><span class="s2">:</span>
                <span class="s1">excluded </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">continue</span>

            <span class="s0">if </span><span class="s1">excluded</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">exclude_frames </span><span class="s0">is not None</span>
                <span class="s0">yield </span><span class="s1">Text</span><span class="s2">(</span>
                    <span class="s3">f&quot;</span><span class="s0">\n</span><span class="s3">... </span><span class="s0">{</span><span class="s1">len</span><span class="s2">(</span><span class="s1">exclude_frames</span><span class="s2">)</span><span class="s0">} </span><span class="s3">frames hidden ...&quot;</span><span class="s2">,</span>
                    <span class="s1">justify</span><span class="s2">=</span><span class="s3">&quot;center&quot;</span><span class="s2">,</span>
                    <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;traceback.error&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
                <span class="s1">excluded </span><span class="s2">= </span><span class="s0">False</span>

            <span class="s1">first </span><span class="s2">= </span><span class="s1">frame_index </span><span class="s2">== </span><span class="s4">0</span>
            <span class="s1">frame_filename </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span>
            <span class="s1">suppressed </span><span class="s2">= </span><span class="s1">any</span><span class="s2">(</span><span class="s1">frame_filename</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">for </span><span class="s1">path </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">suppress</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">):</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                    <span class="s1">path_highlighter</span><span class="s2">(</span><span class="s1">Text</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pygments.string&quot;</span><span class="s2">)),</span>
                    <span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">), </span><span class="s3">&quot;pygments.number&quot;</span><span class="s2">),</span>
                    <span class="s3">&quot; in &quot;</span><span class="s2">,</span>
                    <span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s3">&quot;pygments.function&quot;</span><span class="s2">),</span>
                    <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">text </span><span class="s2">= </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                    <span class="s3">&quot;in &quot;</span><span class="s2">,</span>
                    <span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s3">&quot;pygments.function&quot;</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s3">&quot;:&quot;</span><span class="s2">, </span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">),</span>
                    <span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">), </span><span class="s3">&quot;pygments.number&quot;</span><span class="s2">),</span>
                    <span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;pygments.text&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;&lt;&quot;</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">first</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s3">&quot;&quot;</span>
            <span class="s0">yield </span><span class="s1">text</span>
            <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;&lt;&quot;</span><span class="s2">):</span>
                <span class="s0">yield from </span><span class="s1">render_locals</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>
                <span class="s0">continue</span>
            <span class="s0">if not </span><span class="s1">suppressed</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">code </span><span class="s2">= </span><span class="s1">read_code</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)</span>
                    <span class="s0">if not </span><span class="s1">code</span><span class="s2">:</span>
                        <span class="s6"># code may be an empty string if the file doesn't exist, OR</span>
                        <span class="s6"># if the traceback filename is generated dynamically</span>
                        <span class="s0">continue</span>
                    <span class="s1">lexer_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_guess_lexer</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">code</span><span class="s2">)</span>
                    <span class="s1">syntax </span><span class="s2">= </span><span class="s1">Syntax</span><span class="s2">(</span>
                        <span class="s1">code</span><span class="s2">,</span>
                        <span class="s1">lexer_name</span><span class="s2">,</span>
                        <span class="s1">theme</span><span class="s2">=</span><span class="s1">theme</span><span class="s2">,</span>
                        <span class="s1">line_numbers</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                        <span class="s1">line_range</span><span class="s2">=(</span>
                            <span class="s1">frame</span><span class="s2">.</span><span class="s1">lineno </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extra_lines</span><span class="s2">,</span>
                            <span class="s1">frame</span><span class="s2">.</span><span class="s1">lineno </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">extra_lines</span><span class="s2">,</span>
                        <span class="s2">),</span>
                        <span class="s1">highlight_lines</span><span class="s2">={</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">lineno</span><span class="s2">},</span>
                        <span class="s1">word_wrap</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">word_wrap</span><span class="s2">,</span>
                        <span class="s1">code_width</span><span class="s2">=</span><span class="s4">88</span><span class="s2">,</span>
                        <span class="s1">indent_guides</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">indent_guides</span><span class="s2">,</span>
                        <span class="s1">dedent</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s0">yield </span><span class="s3">&quot;&quot;</span>
                <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">error</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">Text</span><span class="s2">.</span><span class="s1">assemble</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">\n{</span><span class="s1">error</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;traceback.error&quot;</span><span class="s2">),</span>
                    <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s2">(</span>
                        <span class="s1">Columns</span><span class="s2">(</span>
                            <span class="s2">[</span>
                                <span class="s1">syntax</span><span class="s2">,</span>
                                <span class="s2">*</span><span class="s1">render_locals</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">),</span>
                            <span class="s2">],</span>
                            <span class="s1">padding</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
                        <span class="s2">)</span>
                        <span class="s0">if </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">locals</span>
                        <span class="s0">else </span><span class="s1">syntax</span>
                    <span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>

    <span class="s0">from </span><span class="s2">.</span><span class="s1">console </span><span class="s0">import </span><span class="s1">Console</span>

    <span class="s1">console </span><span class="s2">= </span><span class="s1">Console</span><span class="s2">()</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s0">def </span><span class="s1">bar</span><span class="s2">(</span><span class="s1">a</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># </span>
        <span class="s1">one </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">one </span><span class="s2">/ </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">a</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">_rich_traceback_guard </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">zed </span><span class="s2">= {</span>
            <span class="s3">&quot;characters&quot;</span><span class="s2">: {</span>
                <span class="s3">&quot;Paul Atreides&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Vladimir Harkonnen&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Thufir Hawat&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Duncan Idaho&quot;</span><span class="s2">,</span>
            <span class="s2">},</span>
            <span class="s3">&quot;atomic_types&quot;</span><span class="s2">: (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">}</span>
        <span class="s1">bar</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">error</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">foo</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
            <span class="s0">except</span><span class="s2">:</span>
                <span class="s1">slfkjsldkfj  </span><span class="s6"># type: ignore[name-defined]</span>
        <span class="s0">except</span><span class="s2">:</span>
            <span class="s1">console</span><span class="s2">.</span><span class="s1">print_exception</span><span class="s2">(</span><span class="s1">show_locals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">error</span><span class="s2">()</span>
</pre>
</body>
</html>