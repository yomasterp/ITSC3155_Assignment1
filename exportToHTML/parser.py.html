<html>
<head>
<title>parser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
parser.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Base option parser setup&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">optparse</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">suppress</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">, </span><span class="s1">Generator</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Tuple</span>

<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">cli</span><span class="s3">.</span><span class="s1">status_codes </span><span class="s2">import </span><span class="s1">UNKNOWN_ERROR</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">configuration </span><span class="s2">import </span><span class="s1">Configuration</span><span class="s3">, </span><span class="s1">ConfigurationError</span>
<span class="s2">from </span><span class="s1">pip</span><span class="s3">.</span><span class="s1">_internal</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">misc </span><span class="s2">import </span><span class="s1">redact_auth_from_url</span><span class="s3">, </span><span class="s1">strtobool</span>

<span class="s1">logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PrettyHelpFormatter</span><span class="s3">(</span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">IndentedHelpFormatter</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;A prettier/less verbose help formatter for optparse.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s4"># help position must be aligned with __init__.parseopts.description</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;max_help_position&quot;</span><span class="s3">] = </span><span class="s6">30</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;indent_increment&quot;</span><span class="s3">] = </span><span class="s6">1</span>
        <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">] = </span><span class="s1">shutil</span><span class="s3">.</span><span class="s1">get_terminal_size</span><span class="s3">()[</span><span class="s6">0</span><span class="s3">] - </span><span class="s6">2</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">format_option_strings</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">option</span><span class="s3">: </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Option</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_option_strings</span><span class="s3">(</span><span class="s1">option</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_format_option_strings</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">option</span><span class="s3">: </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Option</span><span class="s3">, </span><span class="s1">mvarfmt</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot; &lt;{}&gt;&quot;</span><span class="s3">, </span><span class="s1">optsep</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;, &quot;</span>
    <span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        Return a comma-separated list of option strings and metavars. 
 
        :param option:  tuple of (short opt, long opt), e.g: ('-f', '--format') 
        :param mvarfmt: metavar format string 
        :param optsep:  separator 
        &quot;&quot;&quot;</span>
        <span class="s1">opts </span><span class="s3">= []</span>

        <span class="s2">if </span><span class="s1">option</span><span class="s3">.</span><span class="s1">_short_opts</span><span class="s3">:</span>
            <span class="s1">opts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">option</span><span class="s3">.</span><span class="s1">_short_opts</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">option</span><span class="s3">.</span><span class="s1">_long_opts</span><span class="s3">:</span>
            <span class="s1">opts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">option</span><span class="s3">.</span><span class="s1">_long_opts</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">opts</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">optsep</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">option</span><span class="s3">.</span><span class="s1">takes_value</span><span class="s3">():</span>
            <span class="s2">assert </span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest </span><span class="s2">is not None</span>
            <span class="s1">metavar </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">metavar </span><span class="s2">or </span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
            <span class="s1">opts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">mvarfmt</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">metavar</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()))</span>

        <span class="s2">return </span><span class="s5">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">format_heading</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">heading</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">heading </span><span class="s3">== </span><span class="s5">&quot;Options&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">heading </span><span class="s3">+ </span><span class="s5">&quot;:</span><span class="s2">\n</span><span class="s5">&quot;</span>

    <span class="s2">def </span><span class="s1">format_usage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">usage</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        Ensure there is only one newline between usage and the first heading 
        if there is no description. 
        &quot;&quot;&quot;</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">Usage: {}</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">indent_lines</span><span class="s3">(</span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">dedent</span><span class="s3">(</span><span class="s1">usage</span><span class="s3">), </span><span class="s5">&quot;  &quot;</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">msg</span>

    <span class="s2">def </span><span class="s1">format_description</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">description</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s4"># leave full control over description to us</span>
        <span class="s2">if </span><span class="s1">description</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parser</span><span class="s3">, </span><span class="s5">&quot;main&quot;</span><span class="s3">):</span>
                <span class="s1">label </span><span class="s3">= </span><span class="s5">&quot;Commands&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">label </span><span class="s3">= </span><span class="s5">&quot;Description&quot;</span>
            <span class="s4"># some doc strings have initial newlines, some don't</span>
            <span class="s1">description </span><span class="s3">= </span><span class="s1">description</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s4"># some doc strings have final newlines and spaces, some don't</span>
            <span class="s1">description </span><span class="s3">= </span><span class="s1">description</span><span class="s3">.</span><span class="s1">rstrip</span><span class="s3">()</span>
            <span class="s4"># dedent, then reindent</span>
            <span class="s1">description </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">indent_lines</span><span class="s3">(</span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">dedent</span><span class="s3">(</span><span class="s1">description</span><span class="s3">), </span><span class="s5">&quot;  &quot;</span><span class="s3">)</span>
            <span class="s1">description </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">label</span><span class="s2">}</span><span class="s5">:</span><span class="s2">\n{</span><span class="s1">description</span><span class="s2">}\n</span><span class="s5">&quot;</span>
            <span class="s2">return </span><span class="s1">description</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">format_epilog</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">epilog</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s4"># leave full control over epilog to us</span>
        <span class="s2">if </span><span class="s1">epilog</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">epilog</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">indent_lines</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">indent</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s1">new_lines </span><span class="s3">= [</span><span class="s1">indent </span><span class="s3">+ </span><span class="s1">line </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)]</span>
        <span class="s2">return </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">new_lines</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">UpdatingDefaultsHelpFormatter</span><span class="s3">(</span><span class="s1">PrettyHelpFormatter</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Custom help formatter for use in ConfigOptionParser. 
 
    This is updates the defaults before expanding them, allowing 
    them to show up correctly in the help listing. 
 
    Also redact auth from url type options 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">expand_default</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">option</span><span class="s3">: </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Option</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s1">default_values </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parser </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parser</span><span class="s3">, </span><span class="s1">ConfigOptionParser</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">parser</span><span class="s3">.</span><span class="s1">_update_defaults</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parser</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest </span><span class="s2">is not None</span>
            <span class="s1">default_values </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parser</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">)</span>
        <span class="s1">help_text </span><span class="s3">= </span><span class="s1">super</span><span class="s3">().</span><span class="s1">expand_default</span><span class="s3">(</span><span class="s1">option</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">default_values </span><span class="s2">and </span><span class="s1">option</span><span class="s3">.</span><span class="s1">metavar </span><span class="s3">== </span><span class="s5">&quot;URL&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">default_values</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">default_values </span><span class="s3">= [</span><span class="s1">default_values</span><span class="s3">]</span>

            <span class="s4"># If its not a list, we should abort and just return the help text</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">default_values</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s1">default_values </span><span class="s3">= []</span>

            <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">default_values</span><span class="s3">:</span>
                <span class="s1">help_text </span><span class="s3">= </span><span class="s1">help_text</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">redact_auth_from_url</span><span class="s3">(</span><span class="s1">val</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">help_text</span>


<span class="s2">class </span><span class="s1">CustomOptionParser</span><span class="s3">(</span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">OptionParser</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">insert_option_group</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">idx</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span>
    <span class="s3">) </span><span class="s1">-&gt; optparse</span><span class="s3">.</span><span class="s1">OptionGroup</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Insert an OptionGroup at a given position.&quot;&quot;&quot;</span>
        <span class="s1">group </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">add_option_group</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">option_groups</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">option_groups</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">group</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">group</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">option_list_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Option</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot;Get a list of all options, including those in option groups.&quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">option_list</span><span class="s3">[:]</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">option_groups</span><span class="s3">:</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">i</span><span class="s3">.</span><span class="s1">option_list</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">res</span>


<span class="s2">class </span><span class="s1">ConfigOptionParser</span><span class="s3">(</span><span class="s1">CustomOptionParser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Custom option parser which updates its defaults by checking the 
    configuration files and environmental variables&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s3">*</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">isolated</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">config </span><span class="s3">= </span><span class="s1">Configuration</span><span class="s3">(</span><span class="s1">isolated</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_default</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">option</span><span class="s3">: </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Option</span><span class="s3">, </span><span class="s1">key</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">val</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">option</span><span class="s3">.</span><span class="s1">check_value</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">OptionValueError </span><span class="s2">as </span><span class="s1">exc</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s5">f&quot;An error occurred during configuration: </span><span class="s2">{</span><span class="s1">exc</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s1">sys</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_ordered_configuration_items</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Generator</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s4"># Configuration gives keys in an unordered manner. Order them.</span>
        <span class="s1">override_order </span><span class="s3">= [</span><span class="s5">&quot;global&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s5">&quot;:env:&quot;</span><span class="s3">]</span>

        <span class="s4"># Pool the options into different groups</span>
        <span class="s1">section_items</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]]] = {</span>
            <span class="s1">name</span><span class="s3">: [] </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">override_order</span>
        <span class="s3">}</span>
        <span class="s2">for </span><span class="s1">section_key</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s4"># ignore empty values</span>
            <span class="s2">if not </span><span class="s1">val</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                    <span class="s5">&quot;Ignoring configuration key '%s' as it's value is empty.&quot;</span><span class="s3">,</span>
                    <span class="s1">section_key</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s2">continue</span>

            <span class="s1">section</span><span class="s3">, </span><span class="s1">key </span><span class="s3">= </span><span class="s1">section_key</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">section </span><span class="s2">in </span><span class="s1">override_order</span><span class="s3">:</span>
                <span class="s1">section_items</span><span class="s3">[</span><span class="s1">section</span><span class="s3">].</span><span class="s1">append</span><span class="s3">((</span><span class="s1">key</span><span class="s3">, </span><span class="s1">val</span><span class="s3">))</span>

        <span class="s4"># Yield each group in their override order</span>
        <span class="s2">for </span><span class="s1">section </span><span class="s2">in </span><span class="s1">override_order</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">section_items</span><span class="s3">[</span><span class="s1">section</span><span class="s3">]:</span>
                <span class="s2">yield </span><span class="s1">key</span><span class="s3">, </span><span class="s1">val</span>

    <span class="s2">def </span><span class="s1">_update_defaults</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">defaults</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]) </span><span class="s1">-&gt; Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot;Updates the given defaults with values from the config files and 
        the environ. Does a little special handling for certain types of 
        options (lists).&quot;&quot;&quot;</span>

        <span class="s4"># Accumulate complex default state.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">values </span><span class="s3">= </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">)</span>
        <span class="s1">late_eval </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s4"># Then set the options with those values</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_ordered_configuration_items</span><span class="s3">():</span>
            <span class="s4"># '--' because configuration supports only long names</span>
            <span class="s1">option </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_option</span><span class="s3">(</span><span class="s5">&quot;--&quot; </span><span class="s3">+ </span><span class="s1">key</span><span class="s3">)</span>

            <span class="s4"># Ignore options not present in this parser. E.g. non-globals put</span>
            <span class="s4"># in [global] by users that want them to apply to all applicable</span>
            <span class="s4"># commands.</span>
            <span class="s2">if </span><span class="s1">option </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">continue</span>

            <span class="s2">assert </span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest </span><span class="s2">is not None</span>

            <span class="s2">if </span><span class="s1">option</span><span class="s3">.</span><span class="s1">action </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;store_true&quot;</span><span class="s3">, </span><span class="s5">&quot;store_false&quot;</span><span class="s3">):</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">val </span><span class="s3">= </span><span class="s1">strtobool</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                        <span class="s5">&quot;{} is not a valid value for {} option, &quot;  </span><span class="s4"># noqa</span>
                        <span class="s5">&quot;please specify a boolean value like yes/no, &quot;</span>
                        <span class="s5">&quot;true/false or 1/0 instead.&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
                    <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">option</span><span class="s3">.</span><span class="s1">action </span><span class="s3">== </span><span class="s5">&quot;count&quot;</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">suppress</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                    <span class="s1">val </span><span class="s3">= </span><span class="s1">strtobool</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
                <span class="s2">with </span><span class="s1">suppress</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                    <span class="s1">val </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">int</span><span class="s3">) </span><span class="s2">or </span><span class="s1">val </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                        <span class="s5">&quot;{} is not a valid value for {} option, &quot;  </span><span class="s4"># noqa</span>
                        <span class="s5">&quot;please instead specify either a non-negative integer &quot;</span>
                        <span class="s5">&quot;or a boolean value like yes/no or false/true &quot;</span>
                        <span class="s5">&quot;which is equivalent to 1/0.&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
                    <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">option</span><span class="s3">.</span><span class="s1">action </span><span class="s3">== </span><span class="s5">&quot;append&quot;</span><span class="s3">:</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">val</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()</span>
                <span class="s1">val </span><span class="s3">= [</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_default</span><span class="s3">(</span><span class="s1">option</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">v</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">val</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">option</span><span class="s3">.</span><span class="s1">action </span><span class="s3">== </span><span class="s5">&quot;callback&quot;</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">option</span><span class="s3">.</span><span class="s1">callback </span><span class="s2">is not None</span>
                <span class="s1">late_eval</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">)</span>
                <span class="s1">opt_str </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">get_opt_string</span><span class="s3">()</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">convert_value</span><span class="s3">(</span><span class="s1">opt_str</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>
                <span class="s4"># From take_action</span>
                <span class="s1">args </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">callback_args </span><span class="s2">or </span><span class="s3">()</span>
                <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">callback_kwargs </span><span class="s2">or </span><span class="s3">{}</span>
                <span class="s1">option</span><span class="s3">.</span><span class="s1">callback</span><span class="s3">(</span><span class="s1">option</span><span class="s3">, </span><span class="s1">opt_str</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_default</span><span class="s3">(</span><span class="s1">option</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">val</span><span class="s3">)</span>

            <span class="s1">defaults</span><span class="s3">[</span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">] = </span><span class="s1">val</span>

        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">late_eval</span><span class="s3">:</span>
            <span class="s1">defaults</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">values </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">return </span><span class="s1">defaults</span>

    <span class="s2">def </span><span class="s1">get_default_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; optparse</span><span class="s3">.</span><span class="s1">Values</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Overriding to make updating the defaults after instantiation of 
        the option parser possible, _update_defaults() does the dirty work.&quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">process_default_values</span><span class="s3">:</span>
            <span class="s4"># Old, pre-Optik 1.5 behaviour.</span>
            <span class="s2">return </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">)</span>

        <span class="s4"># Load the configuration, or error out in case of an error</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s1">ConfigurationError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s1">UNKNOWN_ERROR</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">err</span><span class="s3">))</span>

        <span class="s1">defaults </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_update_defaults</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">defaults</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())  </span><span class="s4"># ours</span>
        <span class="s2">for </span><span class="s1">option </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_all_options</span><span class="s3">():</span>
            <span class="s2">assert </span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest </span><span class="s2">is not None</span>
            <span class="s1">default </span><span class="s3">= </span><span class="s1">defaults</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">default</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">opt_str </span><span class="s3">= </span><span class="s1">option</span><span class="s3">.</span><span class="s1">get_opt_string</span><span class="s3">()</span>
                <span class="s1">defaults</span><span class="s3">[</span><span class="s1">option</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">] = </span><span class="s1">option</span><span class="s3">.</span><span class="s1">check_value</span><span class="s3">(</span><span class="s1">opt_str</span><span class="s3">, </span><span class="s1">default</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">optparse</span><span class="s3">.</span><span class="s1">Values</span><span class="s3">(</span><span class="s1">defaults</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">print_usage</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exit</span><span class="s3">(</span><span class="s1">UNKNOWN_ERROR</span><span class="s3">, </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}\n</span><span class="s5">&quot;</span><span class="s3">)</span>
</pre>
</body>
</html>